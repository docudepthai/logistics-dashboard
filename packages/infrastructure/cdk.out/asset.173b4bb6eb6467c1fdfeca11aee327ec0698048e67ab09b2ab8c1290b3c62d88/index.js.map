{
  "version": 3,
  "sources": ["../../../lambda/src/handlers/payment.ts"],
  "sourcesContent": ["import type { APIGatewayProxyEvent, APIGatewayProxyResult } from 'aws-lambda';\nimport { createHmac } from 'crypto';\nimport { DynamoDBClient } from '@aws-sdk/client-dynamodb';\nimport { DynamoDBDocumentClient, UpdateCommand, GetCommand } from '@aws-sdk/lib-dynamodb';\n\n// DynamoDB client\nconst dynamoClient = new DynamoDBClient({});\nconst docClient = DynamoDBDocumentClient.from(dynamoClient);\nconst CONVERSATIONS_TABLE = process.env.CONVERSATIONS_TABLE || 'turkish-logistics-conversations';\n\n// PayTR credentials from environment\nconst PAYTR_MERCHANT_ID = process.env.PAYTR_MERCHANT_ID || '';\nconst PAYTR_MERCHANT_KEY = process.env.PAYTR_MERCHANT_KEY || '';\nconst PAYTR_MERCHANT_SALT = process.env.PAYTR_MERCHANT_SALT || '';\n\n// Subscription price in kuru\u015F (1000 TL = 100000 kuru\u015F)\nconst SUBSCRIPTION_PRICE = process.env.SUBSCRIPTION_PRICE || '100000'; // 1000 TL\nconst SUBSCRIPTION_DAYS = 30; // 1 month\n\ninterface PayTRTokenResponse {\n  status: 'success' | 'failed';\n  token?: string;\n  reason?: string;\n}\n\ninterface PayTRWebhookPayload {\n  merchant_oid: string;\n  status: 'success' | 'failed';\n  total_amount: string;\n  hash: string;\n  failed_reason_msg?: string;\n}\n\nfunction response(statusCode: number, body: unknown): APIGatewayProxyResult {\n  return {\n    statusCode,\n    headers: {\n      'Content-Type': 'application/json',\n      'Access-Control-Allow-Origin': '*',\n    },\n    body: JSON.stringify(body),\n  };\n}\n\n/**\n * Generate a PayTR payment link for a user\n */\nasync function generatePaymentLink(phoneNumber: string, userIp: string): Promise<{\n  success: boolean;\n  paymentUrl?: string;\n  error?: string;\n}> {\n  if (!PAYTR_MERCHANT_ID || !PAYTR_MERCHANT_KEY || !PAYTR_MERCHANT_SALT) {\n    return { success: false, error: 'PayTR credentials not configured' };\n  }\n\n  // Generate unique order ID: phoneTimestamp (alphanumeric only for PayTR)\n  const merchantOid = `${phoneNumber}${Date.now()}`;\n\n  // User details (minimal for WhatsApp users)\n  const email = `${phoneNumber}@whatsapp.logistics.local`;\n  const userName = phoneNumber;\n  const userPhone = phoneNumber.startsWith('90') ? phoneNumber : `90${phoneNumber}`;\n\n  // Basket: 1 month subscription\n  const basketItems = [['Lojistik Bot Premium Uyelik (1 Ay)', (parseInt(SUBSCRIPTION_PRICE) / 100).toFixed(2), 1]];\n  const userBasket = Buffer.from(JSON.stringify(basketItems)).toString('base64');\n\n  // Generate PayTR token (order: merchant_id + user_ip + merchant_oid + email + payment_amount + user_basket + no_installment + max_installment + currency + test_mode)\n  const noInstallment = '0';\n  const maxInstallment = '0';\n  const currency = 'TL';\n  const testMode = '0'; // Production mode\n\n  const hashStr = PAYTR_MERCHANT_ID + userIp + merchantOid + email +\n                  SUBSCRIPTION_PRICE + userBasket + noInstallment + maxInstallment + currency + testMode;\n\n  console.log('Hash components:', {\n    merchant_id: PAYTR_MERCHANT_ID,\n    user_ip: userIp,\n    merchant_oid: merchantOid,\n    email,\n    payment_amount: SUBSCRIPTION_PRICE,\n    user_basket: userBasket,\n    no_installment: noInstallment,\n    max_installment: maxInstallment,\n    currency,\n    test_mode: testMode,\n    hashStr_length: hashStr.length,\n  });\n\n  const paytrToken = createHmac('sha256', PAYTR_MERCHANT_KEY)\n    .update(hashStr + PAYTR_MERCHANT_SALT)\n    .digest('base64');\n\n  console.log('Generated token length:', paytrToken.length);\n\n  // Webhook URL - this Lambda's /webhook endpoint\n  const webhookUrl = process.env.PAYMENT_WEBHOOK_URL || 'https://t50lrx3amk.execute-api.eu-central-1.amazonaws.com/prod/payment';\n\n  try {\n    const formData = new URLSearchParams({\n      merchant_id: PAYTR_MERCHANT_ID,\n      user_ip: userIp,\n      merchant_oid: merchantOid,\n      email,\n      payment_amount: SUBSCRIPTION_PRICE,\n      paytr_token: paytrToken,\n      user_basket: userBasket,\n      debug_on: testMode, // Enable debug in test mode\n      no_installment: noInstallment,\n      max_installment: maxInstallment,\n      user_name: userName,\n      user_address: 'Turkey',\n      user_phone: userPhone,\n      merchant_ok_url: `${webhookUrl}?status=ok&phone=${phoneNumber}`,\n      merchant_fail_url: `${webhookUrl}?status=fail&phone=${phoneNumber}`,\n      merchant_notify_url: webhookUrl,\n      timeout_limit: '30',\n      currency: currency,\n      test_mode: testMode,\n      lang: 'tr',\n    });\n\n    console.log('PayTR request:', {\n      merchant_id: PAYTR_MERCHANT_ID,\n      merchant_oid: merchantOid,\n      payment_amount: SUBSCRIPTION_PRICE,\n      email,\n      user_ip: userIp,\n    });\n\n    const res = await fetch('https://www.paytr.com/odeme/api/get-token', {\n      method: 'POST',\n      headers: { 'Content-Type': 'application/x-www-form-urlencoded' },\n      body: formData.toString(),\n    });\n\n    console.log('PayTR response status:', res.status, res.statusText);\n    const responseText = await res.text();\n    console.log('PayTR raw response:', responseText || '(empty)');\n\n    let data: PayTRTokenResponse;\n    try {\n      data = JSON.parse(responseText) as PayTRTokenResponse;\n    } catch {\n      console.error('Failed to parse PayTR response:', responseText);\n      return { success: false, error: 'Invalid response from payment service' };\n    }\n\n    if (data.status === 'success' && data.token) {\n      // Store pending payment in DynamoDB\n      await docClient.send(new UpdateCommand({\n        TableName: CONVERSATIONS_TABLE,\n        Key: { pk: `PAYMENT#${merchantOid}`, sk: 'PENDING' },\n        UpdateExpression: 'SET phoneNumber = :phone, amount = :amount, createdAt = :now, #s = :status',\n        ExpressionAttributeNames: { '#s': 'status' },\n        ExpressionAttributeValues: {\n          ':phone': phoneNumber,\n          ':amount': parseInt(SUBSCRIPTION_PRICE) / 100,\n          ':now': new Date().toISOString(),\n          ':status': 'pending',\n        },\n      }));\n\n      return {\n        success: true,\n        paymentUrl: `https://www.paytr.com/odeme/guvenli/${data.token}`,\n      };\n    } else {\n      console.error('PayTR token error:', data.reason);\n      return { success: false, error: data.reason || 'Token generation failed' };\n    }\n  } catch (error) {\n    console.error('PayTR API error:', error);\n    return { success: false, error: 'Payment service unavailable' };\n  }\n}\n\n/**\n * Handle PayTR webhook callback\n */\nasync function handleWebhook(payload: PayTRWebhookPayload): Promise<boolean> {\n  console.log('PayTR webhook received:', JSON.stringify(payload, null, 2));\n\n  // Verify hash\n  const hashStr = payload.merchant_oid + PAYTR_MERCHANT_SALT + payload.status + payload.total_amount;\n  const calculatedHash = createHmac('sha256', PAYTR_MERCHANT_KEY)\n    .update(hashStr)\n    .digest('base64');\n\n  console.log('Hash verification:', {\n    received: payload.hash,\n    calculated: calculatedHash,\n    match: calculatedHash === payload.hash\n  });\n\n  if (calculatedHash !== payload.hash) {\n    console.error('PayTR hash verification failed');\n    return false;\n  }\n\n  // Look up phone number from payment record (more reliable than extracting from merchantOid)\n  let phoneNumber: string | undefined;\n  try {\n    const paymentRecord = await docClient.send(new GetCommand({\n      TableName: CONVERSATIONS_TABLE,\n      Key: { pk: `PAYMENT#${payload.merchant_oid}`, sk: 'PENDING' },\n    }));\n    phoneNumber = paymentRecord.Item?.phoneNumber as string;\n    console.log('Found phone from payment record:', phoneNumber);\n  } catch (err) {\n    console.error('Error looking up payment record:', err);\n  }\n\n  // Fallback: extract from merchant_oid (phone numbers can be 10-12 digits)\n  if (!phoneNumber) {\n    // Try different phone number lengths (US: 11 digits, Turkish: 12 digits)\n    const phoneMatch = payload.merchant_oid.match(/^(\\d{10,12})/);\n    if (phoneMatch && phoneMatch[1]) {\n      // If starts with 90, it's Turkish (12 digits); otherwise check length\n      const extracted = phoneMatch[1];\n      if (extracted.startsWith('90') && extracted.length >= 12) {\n        phoneNumber = extracted.substring(0, 12);\n      } else if (extracted.startsWith('1') && extracted.length >= 11) {\n        phoneNumber = extracted.substring(0, 11);\n      } else {\n        phoneNumber = extracted;\n      }\n    } else {\n      phoneNumber = payload.merchant_oid.substring(0, 11);\n    }\n    console.log('Extracted phone from merchantOid:', phoneNumber);\n  }\n\n  if (payload.status === 'success') {\n    // Calculate new expiration date (30 days from now)\n    const paidUntil = new Date();\n    paidUntil.setDate(paidUntil.getDate() + SUBSCRIPTION_DAYS);\n\n    // Update user to premium\n    await docClient.send(new UpdateCommand({\n      TableName: CONVERSATIONS_TABLE,\n      Key: { pk: `USER#${phoneNumber}`, sk: 'PROFILE' },\n      UpdateExpression: 'SET membershipStatus = :status, paidUntil = :paidUntil, paymentId = :paymentId, updatedAt = :now',\n      ExpressionAttributeValues: {\n        ':status': 'premium',\n        ':paidUntil': paidUntil.toISOString(),\n        ':paymentId': payload.merchant_oid,\n        ':now': new Date().toISOString(),\n      },\n    }));\n\n    // Update payment record\n    await docClient.send(new UpdateCommand({\n      TableName: CONVERSATIONS_TABLE,\n      Key: { pk: `PAYMENT#${payload.merchant_oid}`, sk: 'PENDING' },\n      UpdateExpression: 'SET #s = :status, paidAt = :now, totalAmount = :amount',\n      ExpressionAttributeNames: { '#s': 'status' },\n      ExpressionAttributeValues: {\n        ':status': 'success',\n        ':now': new Date().toISOString(),\n        ':amount': parseInt(payload.total_amount) / 100,\n      },\n    }));\n\n    console.log(`User ${phoneNumber} upgraded to premium until ${paidUntil.toISOString()}`);\n    return true;\n  } else {\n    console.log(`Payment failed for ${phoneNumber}: ${payload.failed_reason_msg}`);\n\n    // Update payment record as failed\n    await docClient.send(new UpdateCommand({\n      TableName: CONVERSATIONS_TABLE,\n      Key: { pk: `PAYMENT#${payload.merchant_oid}`, sk: 'PENDING' },\n      UpdateExpression: 'SET #s = :status, failedAt = :now, failReason = :reason',\n      ExpressionAttributeNames: { '#s': 'status' },\n      ExpressionAttributeValues: {\n        ':status': 'failed',\n        ':now': new Date().toISOString(),\n        ':reason': payload.failed_reason_msg || 'Unknown error',\n      },\n    }));\n\n    return true;\n  }\n}\n\nexport async function handler(event: APIGatewayProxyEvent): Promise<APIGatewayProxyResult> {\n  console.log('Payment handler:', event.httpMethod, event.path, event.queryStringParameters);\n  if (event.httpMethod === 'POST') {\n    console.log('POST body:', event.body?.substring(0, 500));\n    console.log('POST headers:', JSON.stringify(event.headers, null, 2));\n  }\n\n  // Handle CORS preflight\n  if (event.httpMethod === 'OPTIONS') {\n    return {\n      statusCode: 200,\n      headers: {\n        'Access-Control-Allow-Origin': '*',\n        'Access-Control-Allow-Methods': 'GET, POST, OPTIONS',\n        'Access-Control-Allow-Headers': 'Content-Type',\n      },\n      body: '',\n    };\n  }\n\n  // GET /payment?status=ok - Payment success page (redirect from PayTR)\n  if (event.httpMethod === 'GET' && event.queryStringParameters?.status === 'ok') {\n    const phone = event.queryStringParameters.phone || '';\n    return {\n      statusCode: 200,\n      headers: { 'Content-Type': 'text/html; charset=utf-8' },\n      body: `<!DOCTYPE html>\n<html><head><meta charset=\"utf-8\"><title>Odeme Basarili</title>\n<meta name=\"viewport\" content=\"width=device-width, initial-scale=1\">\n<style>body{font-family:sans-serif;text-align:center;padding:50px;background:#f0fff0;}</style></head>\n<body>\n<h1 style=\"color:green;\">\u2705 Odeme Basarili!</h1>\n<p>Tebrikler! Premium uyeliginiz aktif edildi.</p>\n<p>Artik tum telefon numaralarini gorebilirsiniz.</p>\n<p style=\"margin-top:30px;color:#666;\">WhatsApp'a donup yuk aramaya devam edebilirsiniz.</p>\n</body></html>`,\n    };\n  }\n\n  // GET /payment?status=fail - Payment failed page (redirect from PayTR)\n  if (event.httpMethod === 'GET' && event.queryStringParameters?.status === 'fail') {\n    const phone = event.queryStringParameters.phone || '';\n    const retryUrl = `https://t50lrx3amk.execute-api.eu-central-1.amazonaws.com/prod/payment?phone=${phone}`;\n    return {\n      statusCode: 200,\n      headers: { 'Content-Type': 'text/html; charset=utf-8' },\n      body: `<!DOCTYPE html>\n<html><head><meta charset=\"utf-8\"><title>Odeme Basarisiz</title>\n<meta name=\"viewport\" content=\"width=device-width, initial-scale=1\">\n<style>body{font-family:sans-serif;text-align:center;padding:50px;background:#fff0f0;}</style></head>\n<body>\n<h1 style=\"color:red;\">\u274C Odeme Basarisiz</h1>\n<p>Odeme islemi tamamlanamadi.</p>\n<p>Lutfen tekrar deneyin veya farkli bir kart kullanin.</p>\n<p style=\"margin-top:30px;\"><a href=\"${retryUrl}\" style=\"background:#007bff;color:white;padding:15px 30px;text-decoration:none;border-radius:5px;\">Tekrar Dene</a></p>\n</body></html>`,\n    };\n  }\n\n  // GET /payment?phone=905321234567 - Generate payment link and redirect to PayTR\n  if (event.httpMethod === 'GET' && event.queryStringParameters?.phone) {\n    const phoneNumber = event.queryStringParameters.phone;\n    const userIp = event.requestContext.identity?.sourceIp || '127.0.0.1';\n\n    const result = await generatePaymentLink(phoneNumber, userIp);\n\n    if (result.success && result.paymentUrl) {\n      // Redirect directly to PayTR payment page (better UX for WhatsApp users)\n      return {\n        statusCode: 302,\n        headers: {\n          'Location': result.paymentUrl,\n          'Cache-Control': 'no-cache, no-store, must-revalidate',\n        },\n        body: '',\n      };\n    } else {\n      // Show error page\n      return {\n        statusCode: 500,\n        headers: { 'Content-Type': 'text/html; charset=utf-8' },\n        body: `<!DOCTYPE html>\n<html><head><title>Odeme Hatasi</title></head>\n<body style=\"font-family: sans-serif; text-align: center; padding: 50px;\">\n<h1>Odeme Baslatilamadi</h1>\n<p>Hata: ${result.error || 'Bilinmeyen hata'}</p>\n<p>Lutfen tekrar deneyin veya destek ile iletisime gecin.</p>\n</body></html>`,\n      };\n    }\n  }\n\n  // POST /payment - PayTR webhook callback\n  if (event.httpMethod === 'POST') {\n    try {\n      // PayTR sends form-urlencoded data\n      const body = event.isBase64Encoded\n        ? Buffer.from(event.body || '', 'base64').toString('utf-8')\n        : event.body || '';\n\n      const params = new URLSearchParams(body);\n      const payload: PayTRWebhookPayload = {\n        merchant_oid: params.get('merchant_oid') || '',\n        status: (params.get('status') || 'failed') as 'success' | 'failed',\n        total_amount: params.get('total_amount') || '0',\n        hash: params.get('hash') || '',\n        failed_reason_msg: params.get('failed_reason_msg') || undefined,\n      };\n\n      const success = await handleWebhook(payload);\n\n      // PayTR expects plain text \"OK\" response\n      return {\n        statusCode: 200,\n        headers: { 'Content-Type': 'text/plain' },\n        body: 'OK',\n      };\n    } catch (error) {\n      console.error('Webhook error:', error);\n      // Still return OK to prevent retries\n      return {\n        statusCode: 200,\n        headers: { 'Content-Type': 'text/plain' },\n        body: 'OK',\n      };\n    }\n  }\n\n  return response(405, { error: 'Method not allowed' });\n}\n"],
  "mappings": "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",
  "names": ["payment_exports", "__export", "handler", "__toCommonJS", "import_crypto", "import_client_dynamodb", "import_lib_dynamodb", "dynamoClient", "docClient", "CONVERSATIONS_TABLE", "PAYTR_MERCHANT_ID", "PAYTR_MERCHANT_KEY", "PAYTR_MERCHANT_SALT", "SUBSCRIPTION_PRICE", "SUBSCRIPTION_DAYS", "response", "statusCode", "body", "generatePaymentLink", "phoneNumber", "userIp", "merchantOid", "email", "userName", "userPhone", "basketItems", "userBasket", "noInstallment", "maxInstallment", "currency", "testMode", "hashStr", "paytrToken", "webhookUrl", "formData", "res", "responseText", "data", "error", "handleWebhook", "payload", "calculatedHash", "err", "phoneMatch", "extracted", "paidUntil", "event", "phone", "retryUrl", "result", "params", "success"]
}
