"use strict";var w=Object.defineProperty;var C=Object.getOwnPropertyDescriptor;var O=Object.getOwnPropertyNames;var x=Object.prototype.hasOwnProperty;var N=(e,t)=>{for(var s in t)w(e,s,{get:t[s],enumerable:!0})},U=(e,t,s,n)=>{if(t&&typeof t=="object"||typeof t=="function")for(let o of O(t))!x.call(e,o)&&o!==s&&w(e,o,{get:()=>t[o],enumerable:!(n=C(t,o))||n.enumerable});return e};var D=e=>U(w({},"__esModule",{value:!0}),e);var G={};N(G,{handler:()=>L});module.exports=D(G);var R=require("crypto"),b=require("@aws-sdk/client-dynamodb"),a=require("@aws-sdk/lib-dynamodb"),M=new b.DynamoDBClient({}),m=a.DynamoDBDocumentClient.from(M),d=process.env.CONVERSATIONS_TABLE||"turkish-logistics-conversations",l=process.env.PAYTR_MERCHANT_ID||"",A=process.env.PAYTR_MERCHANT_KEY||"",S=process.env.PAYTR_MERCHANT_SALT||"",c=process.env.SUBSCRIPTION_PRICE||"100000",$=30;function B(e,t){return{statusCode:e,headers:{"Content-Type":"application/json","Access-Control-Allow-Origin":"*"},body:JSON.stringify(t)}}async function H(e,t){if(!l||!A||!S)return{success:!1,error:"PayTR credentials not configured"};let s=`${e}${Date.now()}`,n=`${e}@whatsapp.logistics.local`,o=e,r=e.startsWith("90")?e:`90${e}`,I=[["Lojistik Bot Premium Uyelik (1 Ay)",(parseInt(c)/100).toFixed(2),1]],h=Buffer.from(JSON.stringify(I)).toString("base64"),p="0",y="0",_="TL",u="1",E=l+t+s+n+c+h+p+y+_+u;console.log("Hash components:",{merchant_id:l,user_ip:t,merchant_oid:s,email:n,payment_amount:c,user_basket:h,no_installment:p,max_installment:y,currency:_,test_mode:u,hashStr_length:E.length});let k=(0,R.createHmac)("sha256",A).update(E+S).digest("base64");console.log("Generated token length:",k.length);let T=process.env.PAYMENT_WEBHOOK_URL||"https://t50lrx3amk.execute-api.eu-central-1.amazonaws.com/prod/payment";try{let P=new URLSearchParams({merchant_id:l,user_ip:t,merchant_oid:s,email:n,payment_amount:c,paytr_token:k,user_basket:h,debug_on:u,no_installment:p,max_installment:y,user_name:o,user_address:"Turkey",user_phone:r,merchant_ok_url:`${T}?status=ok&phone=${e}`,merchant_fail_url:`${T}?status=fail&phone=${e}`,merchant_notify_url:T,timeout_limit:"30",currency:_,test_mode:u,lang:"tr"});console.log("PayTR request:",{merchant_id:l,merchant_oid:s,payment_amount:c,email:n,user_ip:t});let g=await fetch("https://www.paytr.com/odeme/api/get-token",{method:"POST",headers:{"Content-Type":"application/x-www-form-urlencoded"},body:P.toString()});console.log("PayTR response status:",g.status,g.statusText);let f=await g.text();console.log("PayTR raw response:",f||"(empty)");let i;try{i=JSON.parse(f)}catch{return console.error("Failed to parse PayTR response:",f),{success:!1,error:"Invalid response from payment service"}}return i.status==="success"&&i.token?(await m.send(new a.UpdateCommand({TableName:d,Key:{pk:`PAYMENT#${s}`,sk:"PENDING"},UpdateExpression:"SET phoneNumber = :phone, amount = :amount, createdAt = :now, #s = :status",ExpressionAttributeNames:{"#s":"status"},ExpressionAttributeValues:{":phone":e,":amount":parseInt(c)/100,":now":new Date().toISOString(),":status":"pending"}})),{success:!0,paymentUrl:`https://www.paytr.com/odeme/guvenli/${i.token}`}):(console.error("PayTR token error:",i.reason),{success:!1,error:i.reason||"Token generation failed"})}catch(P){return console.error("PayTR API error:",P),{success:!1,error:"Payment service unavailable"}}}async function Y(e){console.log("PayTR webhook received:",e);let t=e.merchant_oid+S+e.status+e.total_amount;if((0,R.createHmac)("sha256",A).update(t).digest("base64")!==e.hash)return console.error("PayTR hash verification failed"),!1;let n=e.merchant_oid.match(/^(\d{12})/),o=n?n[1]:e.merchant_oid.substring(0,12);if(e.status==="success"){let r=new Date;return r.setDate(r.getDate()+$),await m.send(new a.UpdateCommand({TableName:d,Key:{pk:`USER#${o}`,sk:"PROFILE"},UpdateExpression:"SET membershipStatus = :status, paidUntil = :paidUntil, paymentId = :paymentId, updatedAt = :now",ExpressionAttributeValues:{":status":"premium",":paidUntil":r.toISOString(),":paymentId":e.merchant_oid,":now":new Date().toISOString()}})),await m.send(new a.UpdateCommand({TableName:d,Key:{pk:`PAYMENT#${e.merchant_oid}`,sk:"PENDING"},UpdateExpression:"SET #s = :status, paidAt = :now, totalAmount = :amount",ExpressionAttributeNames:{"#s":"status"},ExpressionAttributeValues:{":status":"success",":now":new Date().toISOString(),":amount":parseInt(e.total_amount)/100}})),console.log(`User ${o} upgraded to premium until ${r.toISOString()}`),!0}else return console.log(`Payment failed for ${o}: ${e.failed_reason_msg}`),await m.send(new a.UpdateCommand({TableName:d,Key:{pk:`PAYMENT#${e.merchant_oid}`,sk:"PENDING"},UpdateExpression:"SET #s = :status, failedAt = :now, failReason = :reason",ExpressionAttributeNames:{"#s":"status"},ExpressionAttributeValues:{":status":"failed",":now":new Date().toISOString(),":reason":e.failed_reason_msg||"Unknown error"}})),!0}async function L(e){if(console.log("Payment handler:",e.httpMethod,e.path),e.httpMethod==="OPTIONS")return{statusCode:200,headers:{"Access-Control-Allow-Origin":"*","Access-Control-Allow-Methods":"GET, POST, OPTIONS","Access-Control-Allow-Headers":"Content-Type"},body:""};if(e.httpMethod==="GET"&&e.queryStringParameters?.phone){let t=e.queryStringParameters.phone,s=e.requestContext.identity?.sourceIp||"127.0.0.1",n=await H(t,s);return n.success&&n.paymentUrl?{statusCode:302,headers:{Location:n.paymentUrl,"Cache-Control":"no-cache, no-store, must-revalidate"},body:""}:{statusCode:500,headers:{"Content-Type":"text/html; charset=utf-8"},body:`<!DOCTYPE html>
<html><head><title>Odeme Hatasi</title></head>
<body style="font-family: sans-serif; text-align: center; padding: 50px;">
<h1>Odeme Baslatilamadi</h1>
<p>Hata: ${n.error||"Bilinmeyen hata"}</p>
<p>Lutfen tekrar deneyin veya destek ile iletisime gecin.</p>
</body></html>`}}if(e.httpMethod==="POST")try{let t=e.isBase64Encoded?Buffer.from(e.body||"","base64").toString("utf-8"):e.body||"",s=new URLSearchParams(t),n={merchant_oid:s.get("merchant_oid")||"",status:s.get("status")||"failed",total_amount:s.get("total_amount")||"0",hash:s.get("hash")||"",failed_reason_msg:s.get("failed_reason_msg")||void 0},o=await Y(n);return{statusCode:200,headers:{"Content-Type":"text/plain"},body:"OK"}}catch(t){return console.error("Webhook error:",t),{statusCode:200,headers:{"Content-Type":"text/plain"},body:"OK"}}return B(405,{error:"Method not allowed"})}0&&(module.exports={handler});
//# sourceMappingURL=index.js.map
