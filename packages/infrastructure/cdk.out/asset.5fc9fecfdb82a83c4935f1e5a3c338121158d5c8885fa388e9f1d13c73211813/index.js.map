{
  "version": 3,
  "sources": ["../../../lambda/src/handlers/auto-nudge.ts"],
  "sourcesContent": ["/**\n * Auto-Nudge Lambda Handler\n *\n * Runs on a schedule (every 15 minutes) to automatically send nudge messages\n * to users who:\n * 1. Haven't performed a search (no lastOrigin/lastDestination in context)\n * 2. Are within the 24h WhatsApp messaging window\n * 3. Haven't been nudged yet\n * 4. Are within the configured trigger window (e.g., 3 hours before window closes)\n *\n * The function is idempotent - it marks users as nudged immediately after sending\n * to prevent duplicate messages.\n */\n\nimport { DynamoDBClient } from '@aws-sdk/client-dynamodb';\nimport { DynamoDBDocumentClient, ScanCommand, UpdateCommand, GetCommand } from '@aws-sdk/lib-dynamodb';\n\n// Initialize clients\nconst dynamoClient = new DynamoDBClient({});\nconst docClient = DynamoDBDocumentClient.from(dynamoClient);\n\n// Constants\nconst TABLE_NAME = process.env.CONVERSATIONS_TABLE || 'turkish-logistics-conversations';\nconst WHATSAPP_PHONE_NUMBER_ID = process.env.WHATSAPP_PHONE_NUMBER_ID;\nconst WHATSAPP_ACCESS_TOKEN = process.env.WHATSAPP_ACCESS_TOKEN;\n\n// Default settings\nconst DEFAULT_SETTINGS = {\n  mode: 'manual' as const,\n  triggerHours: 3,\n  messageTemplate: 'abi merhaba, dun kaydolmu\u015Ftun ama hic is aramadin. nasil calistigini gostereyim mi? ornek: \"istanbul ankara\" yaz, sana yukler gostereyim. bedava 7 gun, istersen dene.',\n};\n\ninterface NudgeSettings {\n  mode: 'automatic' | 'manual';\n  triggerHours: number;\n  messageTemplate: string;\n}\n\ninterface Message {\n  role: string;\n  content: string;\n  timestamp: string;\n}\n\ninterface NudgeResult {\n  phoneNumber: string;\n  success: boolean;\n  error?: string;\n}\n\n/**\n * Fetch nudge settings from DynamoDB\n */\nasync function getNudgeSettings(): Promise<NudgeSettings> {\n  try {\n    const result = await docClient.send(\n      new GetCommand({\n        TableName: TABLE_NAME,\n        Key: { pk: 'SETTINGS', sk: 'NUDGE_CONFIG' },\n      })\n    );\n\n    if (result.Item) {\n      return {\n        mode: result.Item.mode || DEFAULT_SETTINGS.mode,\n        triggerHours: result.Item.triggerHours ?? DEFAULT_SETTINGS.triggerHours,\n        messageTemplate: result.Item.messageTemplate || DEFAULT_SETTINGS.messageTemplate,\n      };\n    }\n\n    return DEFAULT_SETTINGS;\n  } catch (error) {\n    console.error('Failed to fetch nudge settings:', error);\n    return DEFAULT_SETTINGS;\n  }\n}\n\n/**\n * Send a WhatsApp text message\n */\nasync function sendWhatsAppMessage(phoneNumber: string, message: string): Promise<boolean> {\n  if (!WHATSAPP_PHONE_NUMBER_ID || !WHATSAPP_ACCESS_TOKEN) {\n    console.error('WhatsApp credentials not configured');\n    return false;\n  }\n\n  try {\n    const response = await fetch(\n      `https://graph.facebook.com/v18.0/${WHATSAPP_PHONE_NUMBER_ID}/messages`,\n      {\n        method: 'POST',\n        headers: {\n          'Authorization': `Bearer ${WHATSAPP_ACCESS_TOKEN}`,\n          'Content-Type': 'application/json',\n        },\n        body: JSON.stringify({\n          messaging_product: 'whatsapp',\n          to: phoneNumber,\n          type: 'text',\n          text: { body: message },\n        }),\n      }\n    );\n\n    const data = await response.json() as { messages?: Array<{ id: string }> };\n\n    if (data.messages?.[0]?.id) {\n      console.log(`\u2713 Message sent to ${phoneNumber}, message_id: ${data.messages[0].id}`);\n      return true;\n    } else {\n      console.error(`\u2717 Failed to send to ${phoneNumber}:`, JSON.stringify(data));\n      return false;\n    }\n  } catch (error) {\n    console.error(`\u2717 Error sending to ${phoneNumber}:`, error);\n    return false;\n  }\n}\n\n/**\n * Mark a user as nudged in DynamoDB\n */\nasync function markAsNudged(phoneNumber: string): Promise<void> {\n  await docClient.send(\n    new UpdateCommand({\n      TableName: TABLE_NAME,\n      Key: {\n        pk: `USER#${phoneNumber}`,\n        sk: 'CONVERSATION',\n      },\n      UpdateExpression: 'SET nudgeSent = :sent, nudgeSentAt = :at',\n      ExpressionAttributeValues: {\n        ':sent': true,\n        ':at': new Date().toISOString(),\n      },\n    })\n  );\n}\n\n/**\n * Get all eligible users for nudging\n */\nasync function getEligibleUsers(triggerHours: number): Promise<Array<{ phoneNumber: string; hoursRemaining: number }>> {\n  // Scan all items\n  const allItems: any[] = [];\n  let lastEvaluatedKey: Record<string, any> | undefined;\n\n  do {\n    const result = await docClient.send(\n      new ScanCommand({\n        TableName: TABLE_NAME,\n        ExclusiveStartKey: lastEvaluatedKey,\n      })\n    );\n    allItems.push(...(result.Items || []));\n    lastEvaluatedKey = result.LastEvaluatedKey;\n  } while (lastEvaluatedKey);\n\n  // Build maps\n  const conversations = new Map<string, any>();\n\n  for (const item of allItems) {\n    const phone = (item.pk as string)?.replace('USER#', '');\n    if (!phone || !/^[+]?\\d+$/.test(phone) || phone.length < 10) continue;\n\n    if (item.sk === 'CONVERSATION') {\n      conversations.set(phone, item);\n    }\n  }\n\n  const now = Date.now();\n  const eligibleUsers: Array<{ phoneNumber: string; hoursRemaining: number }> = [];\n\n  for (const [phone, conv] of Array.from(conversations.entries())) {\n    const messages: Message[] = conv.messages || [];\n    const context = conv.context || {};\n\n    // Skip if already nudged\n    if (conv.nudgeSent === true) {\n      continue;\n    }\n\n    // Skip if user has searched (has context)\n    if (context.lastOrigin || context.lastDestination) {\n      continue;\n    }\n\n    // Find last user message timestamp\n    const userMessages = messages.filter((m: Message) => m.role === 'user');\n    if (userMessages.length === 0) continue;\n\n    const lastUserMessage = userMessages[userMessages.length - 1];\n    if (!lastUserMessage) continue;\n    const lastMessageAt = new Date(lastUserMessage.timestamp).getTime();\n    const hoursElapsed = (now - lastMessageAt) / (1000 * 60 * 60);\n    const hoursRemaining = 24 - hoursElapsed;\n\n    // Only include if within 24h window AND within trigger window\n    if (hoursRemaining > 0 && hoursRemaining <= triggerHours) {\n      eligibleUsers.push({\n        phoneNumber: phone,\n        hoursRemaining,\n      });\n    }\n  }\n\n  // Sort by urgency (least time remaining first)\n  eligibleUsers.sort((a, b) => a.hoursRemaining - b.hoursRemaining);\n\n  return eligibleUsers;\n}\n\n/**\n * Lambda handler - triggered by EventBridge schedule\n */\nexport async function handler(event: any): Promise<{ statusCode: number; body: string }> {\n  const startTime = Date.now();\n  console.log('=== Auto-Nudge Lambda Started ===');\n  console.log('Event:', JSON.stringify(event));\n\n  try {\n    // 1. Get settings\n    const settings = await getNudgeSettings();\n    console.log(`Settings: mode=${settings.mode}, triggerHours=${settings.triggerHours}`);\n\n    // 2. Check if automatic mode is enabled\n    if (settings.mode !== 'automatic') {\n      console.log('Automatic mode is disabled. Exiting.');\n      return {\n        statusCode: 200,\n        body: JSON.stringify({\n          message: 'Automatic mode disabled',\n          mode: settings.mode,\n        }),\n      };\n    }\n\n    // 3. Get eligible users\n    const eligibleUsers = await getEligibleUsers(settings.triggerHours);\n    console.log(`Found ${eligibleUsers.length} eligible users`);\n\n    if (eligibleUsers.length === 0) {\n      return {\n        statusCode: 200,\n        body: JSON.stringify({\n          message: 'No eligible users to nudge',\n          checked: true,\n        }),\n      };\n    }\n\n    // 4. Send messages with rate limiting (max 10 per run to avoid issues)\n    const maxPerRun = 10;\n    const usersToProcess = eligibleUsers.slice(0, maxPerRun);\n    const results: NudgeResult[] = [];\n\n    for (const user of usersToProcess) {\n      console.log(`Processing ${user.phoneNumber} (${user.hoursRemaining.toFixed(1)}h remaining)`);\n\n      // Mark as nudged FIRST to prevent duplicate sends on retry\n      await markAsNudged(user.phoneNumber);\n\n      // Send the message\n      const success = await sendWhatsAppMessage(user.phoneNumber, settings.messageTemplate);\n\n      results.push({\n        phoneNumber: user.phoneNumber,\n        success,\n        error: success ? undefined : 'Failed to send message',\n      });\n\n      // Small delay between messages to respect rate limits\n      await new Promise(resolve => setTimeout(resolve, 500));\n    }\n\n    // 5. Log summary\n    const successful = results.filter(r => r.success).length;\n    const failed = results.filter(r => !r.success).length;\n    const duration = Date.now() - startTime;\n\n    console.log('=== Auto-Nudge Summary ===');\n    console.log(`Processed: ${results.length}`);\n    console.log(`Successful: ${successful}`);\n    console.log(`Failed: ${failed}`);\n    console.log(`Remaining eligible: ${eligibleUsers.length - usersToProcess.length}`);\n    console.log(`Duration: ${duration}ms`);\n\n    return {\n      statusCode: 200,\n      body: JSON.stringify({\n        message: 'Auto-nudge completed',\n        processed: results.length,\n        successful,\n        failed,\n        remainingEligible: eligibleUsers.length - usersToProcess.length,\n        duration,\n        results,\n      }),\n    };\n  } catch (error) {\n    console.error('Auto-nudge error:', error);\n    return {\n      statusCode: 500,\n      body: JSON.stringify({\n        error: 'Auto-nudge failed',\n        message: error instanceof Error ? error.message : 'Unknown error',\n      }),\n    };\n  }\n}\n"],
  "mappings": "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",
  "names": ["auto_nudge_exports", "__export", "handler", "__toCommonJS", "import_client_dynamodb", "import_lib_dynamodb", "dynamoClient", "docClient", "TABLE_NAME", "WHATSAPP_PHONE_NUMBER_ID", "WHATSAPP_ACCESS_TOKEN", "DEFAULT_SETTINGS", "getNudgeSettings", "result", "error", "sendWhatsAppMessage", "phoneNumber", "message", "data", "markAsNudged", "getEligibleUsers", "triggerHours", "allItems", "lastEvaluatedKey", "conversations", "item", "phone", "now", "eligibleUsers", "conv", "messages", "context", "userMessages", "m", "lastUserMessage", "lastMessageAt", "hoursRemaining", "a", "b", "event", "startTime", "settings", "usersToProcess", "results", "user", "success", "resolve", "successful", "r", "failed", "duration"]
}
