# IMPORTANT: Read This First

Before exploring the codebase or using tools, check if the answer is already in this document. Do NOT launch exploration agents for questions about project structure or architecture.

---

# GitHub Copilot Instructions - Generated by DocuDepth

# Whatsapp_Aggregator_Bot - Codebase Context

> Generated by DocuDepth AI - https://docudepthai.com
> Last updated: 2026-01-25T03:58:40.547Z

## Project Overview

**Whatsapp_Aggregator_Bot**

# Kamyoon Scraper Service

A background service that fetches logistics load offers from Kamyoon's API and sends them to AWS Lambda for processing. Designed to run on Railway.

## Architecture

```
┌─────────────────────┐      ┌──────────────────────────────────────────┐
│                     │      │                                          │
│   Kamyoon API       │─────▶│   Kamyoon Scraper (Railway)              │
│                     │      │                                          │
│   Loa

| Attribute | Value |
|-----------|-------|
| Primary Language | typescript |
| Architecture | Modular |
| Framework | nextjs |
| Total Files | 4 |

## Domain Context

Modular extraction utilities for parsing unstructured logistics WhatsApp messages.

Automates Kamyoon logistics data ingestion into the pipeline.

Defines PostgreSQL schema for logistics data persistence.

## Architecture

**Style:** Modular

20 distinct modules.

## Key Files

### Configuration

- `CLAUDE.md` - Codebase context summary for Claude AI to answer project structure questions without exploration.
- `.aider/context.md` - Codebase context summary for Aider AI to answer project structure questions without exploration.
- `.github/copilot-instructions.md` - Codebase context summary for GitHub Copilot to answer project structure questions without exploration.

## Modules

### extractors

- **Path:** `packages/parser/src/extractors`
- **Role:** Phone number extractor.
- **Business Context:** Modular extraction utilities for parsing unstructured logistics WhatsApp messages.
- **Key Exports:** extractPhoneNumbers (function), extractPrimaryPhone (function), extractLoadType (function), ParsedLoadType (interface), extractUrgency (function), extractCargoType (function), hasCargoAvailable (function), extractVehicle (function), isVehicleWanted (function), isVehicleAvailable (function)

### src

- **Path:** `kamyoon/scraper-service/src`
- **Role:** Main entry for Kamyoon scraper service similar to Yukbul.
- **Business Context:** Automates Kamyoon logistics data ingestion into the pipeline.
- **Key Exports:** KamyoonClient (class), KamyoonLoadOffer (interface), KamyoonApiResponse (interface), EvolutionWebhookPayload (interface), EvolutionMessageData (interface), EvolutionMessageKey (interface), EvolutionMessage (interface), ScraperConfig (interface), ProcessedMessage (interface), transformToWebhookPayload (function)

### schema

- **Path:** `packages/database/src/schema`
- **Role:** Drizzle schema for raw_messages table storing incoming webhook payloads.
- **Business Context:** Defines PostgreSQL schema for logistics data persistence.
- **Key Exports:** rawMessages (function), sourceGroups (function), districts (function), contacts (function), processingLogs (function), jobs (function)

### src

- **Path:** `yukbul/scraper-service/src`
- **Role:** Main entry point for Yukbul scraper service that fetches logistics listings every 15 minutes and sends to webhook.
- **Business Context:** Exists to automate fetching and processing of logistics load offers from Yukbul API for integration into the central logistics processing pipeline via AWS Lambda.
- **Key Exports:** YukbulListing (interface), YukbulTrailerType (interface), YukbulLocation (interface), YukbulApiResponse (interface), EvolutionWebhookPayload (interface), EvolutionMessageData (interface), EvolutionMessageKey (interface), EvolutionMessage (interface), ScraperConfig (interface), ProcessedMessage (interface)

### patron

- **Path:** `patron`
- **Role:** Root monorepo package.json with turbo scripts.
- **Business Context:** Turborepo orchestration.

### functions

- **Path:** `functions/src/functions`
- **Role:** Firebase callable for marketplace payment transfers via PayTR.
- **Business Context:** Releases payments to carriers after job verification.
- **Key Exports:** processMarketplaceTransfer (function), verifyPaymentAndUpdateJob (function), onPaymentStatusUpdate (function), checkStuckPayments (function), cancelJobWithRefund (function), initializePayment (function), queryPaymentStatus (function)
- **Dependencies:** functions/src/types, functions/src/config

### dashboard

- **Path:** `packages/dashboard`
- **Role:** PostCSS config for dashboard
- **Business Context:** Dashboard.

### handlers

- **Path:** `packages/lambda/src/handlers`
- **Role:** WhatsApp bot query handler with AI agent.
- **Business Context:** Core bot logic for user job searches.
- **Key Exports:** handler (function), handler (function), handler (function), handler (function), handler (function)

### constants

- **Path:** `packages/shared/src/constants`
- **Role:** Comprehensive Turkish districts list with provinces.
- **Business Context:** Centralizes Turkish location and vehicle data for consistent parsing and matching.
- **Key Exports:** getDistrictsByName (function), getDistrictByName (function), isDistrictName (function), isAmbiguousDistrict (function), getDistrictsByProvinceCode (function), District (interface), getVehicleTypeByPattern (function), getBodyTypeByPattern (function), VehicleType (interface), BodyType (interface)

### components

- **Path:** `packages/dashboard/src/app/components`
- **Role:** Dashboard sidebar navigation with permissions.
- **Business Context:** Main navigation for ops dashboard.
- **Dependencies:** packages/dashboard/src/app/hooks

### types

- **Path:** `packages/shared/src/types`
- **Role:** Evolution API webhook type definitions.
- **Business Context:** Ensures consistent typing for messages, parsed data, and DB schemas.
- **Key Exports:** isMessagesUpsertEvent (function), isGroupMessage (function), isOwnMessage (function), extractTextFromMessage (function), EvolutionWebhookPayload (interface), EvolutionMessageData (interface), EvolutionMessageKey (interface), EvolutionMessage (interface), RawMessage (interface), Job (interface)

### cdk.out

- **Path:** `packages/infrastructure/cdk.out`
- **Role:** CDK asset manifest for deployment.
- **Business Context:** Infra deployment artifacts.

### src

- **Path:** `packages/parser/src`
- **Role:** Main logistics message parser orchestrator.
- **Business Context:** Core parsing engine for turning WhatsApp messages into structured job data.
- **Key Exports:** parse (function), parseMany (function), isLikelyLogisticsMessage (function), calculateConfidence (function), parseWithAI (function), isAIParsingAvailable (function)

### extractors

- **Path:** `packages/parser/src/__tests__/extractors`
- **Role:** Unit tests for phone extractor
- **Business Context:** Verifies phone parsing accuracy

### src

- **Path:** `packages/agent/src`
- **Role:** DynamoDB store for user conversations and context in WhatsApp AI agent.
- **Business Context:** Core agent logic for conversational job matching.
- **Key Exports:** ConversationStore (class), Message (interface), FrequentRoute (interface), ConversationContext (interface), Conversation (interface), PendingNotification (interface), LogisticsAgent (class), AgentOptions (interface), AgentResponse (interface), UserStore (class)

### scraper-service

- **Path:** `kamyoon/scraper-service`
- **Role:** Kamyoon scraper service package
- **Business Context:** Runs background scraper feeding AWS pipeline.

### infrastructure

- **Path:** `packages/infrastructure`
- **Role:** TS config for CDK infra.
- **Business Context:** AWS infra as code.

### utils

- **Path:** `packages/shared/src/utils`
- **Role:** Barrel export for Turkish text normalization and phone utilities.
- **Business Context:** Provides shared utilities for text processing in logistics parsing across the app.
- **Key Exports:** extractPhoneNumbers (function), normalizePhoneNumber (function), formatPhoneNumber (function), isValidTurkishMobile (function), maskPhoneNumber (function), maskPhoneNumbersInText (function), PhoneMatch (interface), normalizeToAscii (function), stripSuffix (function), normalizeLocationName (function)

### app

- **Path:** `patron/src/app`
- **Role:** Root layout for Patron landing site.
- **Business Context:** Public marketing site.
- **Key Exports:** provinceCoordinates (function)

### queries

- **Path:** `packages/database/src/queries`
- **Role:** Barrel export for job and message queries.
- **Business Context:** Query builders for efficient DB operations in processors.
- **Key Exports:** insertJob (function), getJobByMessageId (function), jobExists (function), getJobs (function), getJobsByRoute (function), deactivateOldJobs (function), getJobStats (function), JobFilters (interface), insertRawMessage (function), getRawMessageByMessageId (function)

## Code Patterns & Conventions

### cronjob

Pattern: cronjob

**Used in:** yukbul/scraper-service/src/index.ts, kamyoon/scraper-service/src/index.ts

### barrel exports

Pattern: barrel exports

**Used in:** packages/shared/src/index.ts, packages/shared/src/utils/index.ts, packages/lambda/src/index.ts

### lambda handler

Pattern: lambda handler

**Used in:** packages/infrastructure/cdk.out/asset.173b4bb6eb6467c1fdfeca11aee327ec0698048e67ab09b2ab8c1290b3c62d88/index.js, packages/infrastructure/cdk.out/asset.3ca474ba9b66c9bde2f46896ca6809d57a6557a87db2daae61288e8953c1b748/index.js

### deduplication

Pattern: deduplication

**Used in:** packages/dashboard/src/app/api/analytics/route.ts, packages/agent/src/tools/searchJobs.ts

### paginated scan

Pattern: paginated scan

**Used in:** packages/dashboard/src/app/api/finance/route.ts, packages/dashboard/src/app/api/conversations/route.ts

### responsive grid

Pattern: responsive grid

**Used in:** packages/dashboard/src/app/finance/page.tsx, packages/dashboard/src/app/analytics/page.tsx

### pagination

Pattern: pagination

**Used in:** packages/dashboard/src/app/users/page.tsx, packages/dashboard/src/app/conversations/page.tsx, packages/dashboard/src/app/crm/iletisim-listesi/page.tsx

### search/filter

Pattern: search/filter

**Used in:** packages/dashboard/src/app/users/page.tsx, packages/dashboard/src/app/conversations/page.tsx

### expandable rows

Pattern: expandable rows

**Used in:** packages/dashboard/src/app/conversations/page.tsx, packages/dashboard/src/app/problems/page.tsx

### batch processing

Pattern: batch processing

**Used in:** yukbul/scraper-service/src/webhook-sender.ts, packages/lambda/src/handlers/processor.ts

### callable

Pattern: callable

**Used in:** functions/src/functions/payment.functions.ts, functions/src/functions/status.functions.ts

### lookup maps

Pattern: lookup maps

**Used in:** packages/shared/src/constants/vehicles.ts, packages/shared/src/constants/provinces.ts

### regex

Pattern: regex

**Used in:** packages/parser/src/extractors/weight.ts, packages/parser/src/extractors/contact.ts

### declarative-schema

Pattern: declarative-schema

**Used in:** packages/database/src/schema/messages.ts, packages/database/src/schema/source-groups.ts, packages/database/src/schema/contacts.ts

### repository

Repository pattern for data access

**Used in:** packages/database/src/queries/jobs.queries.ts, packages/database/src/queries/messages.queries.ts

## AI Guidance

### Must Follow

- Use Next.js App Router conventions (page.tsx, layout.tsx)
- Server components by default, add "use client" for interactivity
- Follow existing code style and conventions
- Add appropriate error handling
- Write tests for new functionality

### Must Avoid

- Do not use pages/ directory patterns with App Router
- Do not introduce new dependencies without consideration
- Avoid duplicating existing functionality
- Do not hardcode configuration values

### Common Tasks

**0:**
- Approach: undefined

**1:**
- Approach: undefined

---

## How to Use This Context

This file provides your AI coding assistant with deep understanding of this codebase.
The AI will automatically use this context to:

- Understand the project structure and architecture
- Follow existing code patterns and conventions
- Make accurate suggestions that fit the codebase
- Navigate between related files and modules

For full details, check `.docudepth/context-map.json`.

*This file is auto-generated and updated by DocuDepth. Do not edit manually.*
