{
  "version": 3,
  "sources": ["../../../lambda/src/handlers/payment.ts"],
  "sourcesContent": ["import type { APIGatewayProxyEvent, APIGatewayProxyResult } from 'aws-lambda';\nimport { createHmac } from 'crypto';\nimport { DynamoDBClient } from '@aws-sdk/client-dynamodb';\nimport { DynamoDBDocumentClient, UpdateCommand, GetCommand } from '@aws-sdk/lib-dynamodb';\n\n// DynamoDB client\nconst dynamoClient = new DynamoDBClient({});\nconst docClient = DynamoDBDocumentClient.from(dynamoClient);\nconst CONVERSATIONS_TABLE = process.env.CONVERSATIONS_TABLE || 'turkish-logistics-conversations';\n\n// PayTR credentials from environment\nconst PAYTR_MERCHANT_ID = process.env.PAYTR_MERCHANT_ID || '';\nconst PAYTR_MERCHANT_KEY = process.env.PAYTR_MERCHANT_KEY || '';\nconst PAYTR_MERCHANT_SALT = process.env.PAYTR_MERCHANT_SALT || '';\n\n// Subscription price in kuru\u015F (1000 TL = 100000 kuru\u015F)\nconst SUBSCRIPTION_PRICE = process.env.SUBSCRIPTION_PRICE || '100000'; // 1000 TL\nconst SUBSCRIPTION_DAYS = 30; // 1 month\n\ninterface PayTRTokenResponse {\n  status: 'success' | 'failed';\n  token?: string;\n  reason?: string;\n}\n\ninterface PayTRWebhookPayload {\n  merchant_oid: string;\n  status: 'success' | 'failed';\n  total_amount: string;\n  hash: string;\n  failed_reason_msg?: string;\n}\n\nfunction response(statusCode: number, body: unknown): APIGatewayProxyResult {\n  return {\n    statusCode,\n    headers: {\n      'Content-Type': 'application/json',\n      'Access-Control-Allow-Origin': '*',\n    },\n    body: JSON.stringify(body),\n  };\n}\n\n/**\n * Generate a PayTR payment link for a user\n */\nasync function generatePaymentLink(phoneNumber: string, userIp: string): Promise<{\n  success: boolean;\n  paymentUrl?: string;\n  error?: string;\n}> {\n  if (!PAYTR_MERCHANT_ID || !PAYTR_MERCHANT_KEY || !PAYTR_MERCHANT_SALT) {\n    return { success: false, error: 'PayTR credentials not configured' };\n  }\n\n  // Generate unique order ID: phone_timestamp\n  const merchantOid = `${phoneNumber}_${Date.now()}`;\n\n  // User details (minimal for WhatsApp users)\n  const email = `${phoneNumber}@whatsapp.logistics.local`;\n  const userName = phoneNumber;\n  const userPhone = phoneNumber.startsWith('90') ? phoneNumber : `90${phoneNumber}`;\n\n  // Basket: 1 month subscription\n  const basketItems = [['Lojistik Bot Premium Uyelik (1 Ay)', (parseInt(SUBSCRIPTION_PRICE) / 100).toFixed(2), 1]];\n  const userBasket = Buffer.from(JSON.stringify(basketItems)).toString('base64');\n\n  // Generate PayTR token\n  const hashStr = PAYTR_MERCHANT_ID + userIp + merchantOid + email +\n                  SUBSCRIPTION_PRICE + userBasket + '0' + '0' + 'TL' + '0'; // test_mode = 0 for production\n\n  const paytrToken = createHmac('sha256', PAYTR_MERCHANT_KEY)\n    .update(hashStr + PAYTR_MERCHANT_SALT)\n    .digest('base64');\n\n  // Webhook URL - this Lambda's /webhook endpoint\n  const webhookUrl = process.env.PAYMENT_WEBHOOK_URL || 'https://t50lrx3amk.execute-api.eu-central-1.amazonaws.com/prod/payment';\n\n  try {\n    const formData = new URLSearchParams({\n      merchant_id: PAYTR_MERCHANT_ID,\n      user_ip: userIp,\n      merchant_oid: merchantOid,\n      email,\n      payment_amount: SUBSCRIPTION_PRICE,\n      paytr_token: paytrToken,\n      user_basket: userBasket,\n      debug_on: '0',\n      no_installment: '1',\n      max_installment: '0',\n      user_name: userName,\n      user_address: 'Turkey',\n      user_phone: userPhone,\n      merchant_ok_url: `${webhookUrl}?status=ok&phone=${phoneNumber}`,\n      merchant_fail_url: `${webhookUrl}?status=fail&phone=${phoneNumber}`,\n      merchant_notify_url: webhookUrl,\n      timeout_limit: '30',\n      currency: 'TL',\n      test_mode: '0',\n      lang: 'tr',\n    });\n\n    const res = await fetch('https://www.paytr.com/odeme/api/get-token', {\n      method: 'POST',\n      headers: { 'Content-Type': 'application/x-www-form-urlencoded' },\n      body: formData.toString(),\n    });\n\n    const data = await res.json() as PayTRTokenResponse;\n\n    if (data.status === 'success' && data.token) {\n      // Store pending payment in DynamoDB\n      await docClient.send(new UpdateCommand({\n        TableName: CONVERSATIONS_TABLE,\n        Key: { pk: `PAYMENT#${merchantOid}`, sk: 'PENDING' },\n        UpdateExpression: 'SET phoneNumber = :phone, amount = :amount, createdAt = :now, #s = :status',\n        ExpressionAttributeNames: { '#s': 'status' },\n        ExpressionAttributeValues: {\n          ':phone': phoneNumber,\n          ':amount': parseInt(SUBSCRIPTION_PRICE) / 100,\n          ':now': new Date().toISOString(),\n          ':status': 'pending',\n        },\n      }));\n\n      return {\n        success: true,\n        paymentUrl: `https://www.paytr.com/odeme/guvenli/${data.token}`,\n      };\n    } else {\n      console.error('PayTR token error:', data.reason);\n      return { success: false, error: data.reason || 'Token generation failed' };\n    }\n  } catch (error) {\n    console.error('PayTR API error:', error);\n    return { success: false, error: 'Payment service unavailable' };\n  }\n}\n\n/**\n * Handle PayTR webhook callback\n */\nasync function handleWebhook(payload: PayTRWebhookPayload): Promise<boolean> {\n  console.log('PayTR webhook received:', payload);\n\n  // Verify hash\n  const hashStr = payload.merchant_oid + PAYTR_MERCHANT_SALT + payload.status + payload.total_amount;\n  const calculatedHash = createHmac('sha256', PAYTR_MERCHANT_KEY)\n    .update(hashStr)\n    .digest('base64');\n\n  if (calculatedHash !== payload.hash) {\n    console.error('PayTR hash verification failed');\n    return false;\n  }\n\n  // Extract phone number from merchant_oid (format: phoneNumber_timestamp)\n  const phoneNumber = payload.merchant_oid.split('_')[0];\n\n  if (payload.status === 'success') {\n    // Calculate new expiration date (30 days from now)\n    const paidUntil = new Date();\n    paidUntil.setDate(paidUntil.getDate() + SUBSCRIPTION_DAYS);\n\n    // Update user to premium\n    await docClient.send(new UpdateCommand({\n      TableName: CONVERSATIONS_TABLE,\n      Key: { pk: `USER#${phoneNumber}`, sk: 'PROFILE' },\n      UpdateExpression: 'SET membershipStatus = :status, paidUntil = :paidUntil, paymentId = :paymentId, updatedAt = :now',\n      ExpressionAttributeValues: {\n        ':status': 'premium',\n        ':paidUntil': paidUntil.toISOString(),\n        ':paymentId': payload.merchant_oid,\n        ':now': new Date().toISOString(),\n      },\n    }));\n\n    // Update payment record\n    await docClient.send(new UpdateCommand({\n      TableName: CONVERSATIONS_TABLE,\n      Key: { pk: `PAYMENT#${payload.merchant_oid}`, sk: 'PENDING' },\n      UpdateExpression: 'SET #s = :status, paidAt = :now, totalAmount = :amount',\n      ExpressionAttributeNames: { '#s': 'status' },\n      ExpressionAttributeValues: {\n        ':status': 'success',\n        ':now': new Date().toISOString(),\n        ':amount': parseInt(payload.total_amount) / 100,\n      },\n    }));\n\n    console.log(`User ${phoneNumber} upgraded to premium until ${paidUntil.toISOString()}`);\n    return true;\n  } else {\n    console.log(`Payment failed for ${phoneNumber}: ${payload.failed_reason_msg}`);\n\n    // Update payment record as failed\n    await docClient.send(new UpdateCommand({\n      TableName: CONVERSATIONS_TABLE,\n      Key: { pk: `PAYMENT#${payload.merchant_oid}`, sk: 'PENDING' },\n      UpdateExpression: 'SET #s = :status, failedAt = :now, failReason = :reason',\n      ExpressionAttributeNames: { '#s': 'status' },\n      ExpressionAttributeValues: {\n        ':status': 'failed',\n        ':now': new Date().toISOString(),\n        ':reason': payload.failed_reason_msg || 'Unknown error',\n      },\n    }));\n\n    return true;\n  }\n}\n\nexport async function handler(event: APIGatewayProxyEvent): Promise<APIGatewayProxyResult> {\n  console.log('Payment handler:', event.httpMethod, event.path);\n\n  // Handle CORS preflight\n  if (event.httpMethod === 'OPTIONS') {\n    return {\n      statusCode: 200,\n      headers: {\n        'Access-Control-Allow-Origin': '*',\n        'Access-Control-Allow-Methods': 'GET, POST, OPTIONS',\n        'Access-Control-Allow-Headers': 'Content-Type',\n      },\n      body: '',\n    };\n  }\n\n  // GET /payment?phone=905321234567 - Generate payment link\n  if (event.httpMethod === 'GET' && event.queryStringParameters?.phone) {\n    const phoneNumber = event.queryStringParameters.phone;\n    const userIp = event.requestContext.identity?.sourceIp || '127.0.0.1';\n\n    const result = await generatePaymentLink(phoneNumber, userIp);\n\n    if (result.success) {\n      return response(200, {\n        success: true,\n        paymentUrl: result.paymentUrl,\n        message: 'Odeme linki olusturuldu',\n      });\n    } else {\n      return response(500, { success: false, error: result.error });\n    }\n  }\n\n  // POST /payment - PayTR webhook callback\n  if (event.httpMethod === 'POST') {\n    try {\n      // PayTR sends form-urlencoded data\n      const body = event.isBase64Encoded\n        ? Buffer.from(event.body || '', 'base64').toString('utf-8')\n        : event.body || '';\n\n      const params = new URLSearchParams(body);\n      const payload: PayTRWebhookPayload = {\n        merchant_oid: params.get('merchant_oid') || '',\n        status: (params.get('status') || 'failed') as 'success' | 'failed',\n        total_amount: params.get('total_amount') || '0',\n        hash: params.get('hash') || '',\n        failed_reason_msg: params.get('failed_reason_msg') || undefined,\n      };\n\n      const success = await handleWebhook(payload);\n\n      // PayTR expects plain text \"OK\" response\n      return {\n        statusCode: 200,\n        headers: { 'Content-Type': 'text/plain' },\n        body: 'OK',\n      };\n    } catch (error) {\n      console.error('Webhook error:', error);\n      // Still return OK to prevent retries\n      return {\n        statusCode: 200,\n        headers: { 'Content-Type': 'text/plain' },\n        body: 'OK',\n      };\n    }\n  }\n\n  return response(405, { error: 'Method not allowed' });\n}\n"],
  "mappings": "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",
  "names": ["payment_exports", "__export", "handler", "__toCommonJS", "import_crypto", "import_client_dynamodb", "import_lib_dynamodb", "dynamoClient", "docClient", "CONVERSATIONS_TABLE", "PAYTR_MERCHANT_ID", "PAYTR_MERCHANT_KEY", "PAYTR_MERCHANT_SALT", "SUBSCRIPTION_PRICE", "SUBSCRIPTION_DAYS", "response", "statusCode", "body", "generatePaymentLink", "phoneNumber", "userIp", "merchantOid", "email", "userName", "userPhone", "basketItems", "userBasket", "hashStr", "paytrToken", "webhookUrl", "formData", "data", "error", "handleWebhook", "payload", "paidUntil", "event", "result", "params", "success"]
}
