"use strict";var f=Object.defineProperty;var k=Object.getOwnPropertyDescriptor;var _=Object.getOwnPropertyNames;var $=Object.prototype.hasOwnProperty;var T=(o,t)=>{for(var e in t)f(o,e,{get:t[e],enumerable:!0})},E=(o,t,e,r)=>{if(t&&typeof t=="object"||typeof t=="function")for(let a of _(t))!$.call(o,a)&&a!==e&&f(o,a,{get:()=>t[a],enumerable:!(r=k(t,a))||r.enumerable});return o};var x=o=>E(f({},"__esModule",{value:!0}),o);var W={};T(W,{handler:()=>R});module.exports=x(W);var I=require("@aws-sdk/client-dynamodb"),p=require("@aws-sdk/lib-dynamodb");var y=class{accessToken=null;tokenExpiry=null;config;constructor(t){this.config=t}async getAccessToken(){if(this.accessToken&&this.tokenExpiry&&this.tokenExpiry>Date.now()+3e5)return this.accessToken;console.log("Parasut: Authenticating...");let t=await fetch("https://api.parasut.com/oauth/token",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({client_id:this.config.clientId,client_secret:this.config.clientSecret,username:this.config.username,password:this.config.password,grant_type:"password",redirect_uri:"urn:ietf:wg:oauth:2.0:oob"})});if(!t.ok){let r=await t.text();throw console.error("Parasut auth failed:",r),new Error("Failed to authenticate with Parasut")}let e=await t.json();return this.accessToken=e.access_token,this.tokenExpiry=Date.now()+(e.expires_in-300)*1e3,console.log("Parasut: Authenticated successfully"),this.accessToken}async createMinimalContact(t){let{companyId:e}=this.config;try{let s=await fetch(`https://api.parasut.com/v4/${e}/contacts?filter[name]=Muhtelif%20M%C3%BC%C5%9Fteriler`,{headers:{Authorization:`Bearer ${t}`}});if(s.ok){let c=(await s.json()).data?.[0];if(c)return console.log("Parasut: Found existing Muhtelif M√º≈üteriler contact"),c.id}}catch{}let r={data:{type:"contacts",attributes:{name:"Muhtelif M√º≈üteriler",contact_type:"person",account_type:"customer",tax_number:"11111111111"}}},a=await fetch(`https://api.parasut.com/v4/${e}/contacts`,{method:"POST",headers:{Authorization:`Bearer ${t}`,"Content-Type":"application/json"},body:JSON.stringify(r)});if(!a.ok){if(a.status===422){console.log("Parasut: Contact already exists, searching...");let n=await fetch(`https://api.parasut.com/v4/${e}/contacts?filter[name]=Muhtelif`,{headers:{Authorization:`Bearer ${t}`}});if(n.ok){let d=(await n.json()).data?.[0];if(d)return d.id}}let s=await a.text();throw console.error("Parasut create minimal contact error:",s),new Error("Failed to create minimal contact")}let i=await a.json();return console.log("Parasut: Created Muhtelif M√º≈üteriler contact:",i.data.id),i.data.id}async createCompanyContact(t,e){let{companyId:r}=this.config;try{let n=await fetch(`https://api.parasut.com/v4/${r}/contacts?filter[tax_number]=${e.vkn}`,{headers:{Authorization:`Bearer ${t}`}});if(n.ok){let d=(await n.json()).data?.[0];if(d)return console.log("Parasut: Found existing company contact by VKN"),d.id}}catch{}let a={data:{type:"contacts",attributes:{name:e.companyName,contact_type:"company",account_type:"customer",tax_office:e.taxOffice,tax_number:e.vkn,address:e.address,city:e.city,district:e.district,email:e.email||void 0,phone:e.phone||void 0}}},i=await fetch(`https://api.parasut.com/v4/${r}/contacts`,{method:"POST",headers:{Authorization:`Bearer ${t}`,"Content-Type":"application/json"},body:JSON.stringify(a)});if(!i.ok){if(i.status===422){let c=await fetch(`https://api.parasut.com/v4/${r}/contacts?filter[tax_number]=${e.vkn}`,{headers:{Authorization:`Bearer ${t}`}});if(c.ok){let u=(await c.json()).data?.[0];if(u)return u.id}}let n=await i.text();throw console.error("Parasut create company contact error:",n),new Error("Failed to create company contact")}let s=await i.json();return console.log("Parasut: Created company contact:",s.data.id),s.data.id}async getOrCreateProduct(t){let{companyId:e}=this.config,r="Patron Premium √úyelik (1 Ay)";try{let n=await fetch(`https://api.parasut.com/v4/${e}/products?filter[name]=${encodeURIComponent(r)}`,{headers:{Authorization:`Bearer ${t}`}});if(n.ok){let d=(await n.json()).data?.[0];if(d)return console.log("Parasut: Found existing product:",d.id),d.id}}catch{console.log("Parasut: Product search failed, will create new")}let a={data:{type:"products",attributes:{name:r,vat_rate:20,unit:"Adet",sales_price:1e3,currency:"TRL",product_type:"service"}}},i=await fetch(`https://api.parasut.com/v4/${e}/products`,{method:"POST",headers:{Authorization:`Bearer ${t}`,"Content-Type":"application/json"},body:JSON.stringify(a)});if(!i.ok){let n=await i.text();throw console.error("Parasut create product error:",n),new Error("Failed to create product")}let s=await i.json();return console.log("Parasut: Created product:",s.data.id),s.data.id}async createSalesInvoice(t,e,r,a){let{companyId:i}=this.config,s=await this.getOrCreateProduct(t),n=r/1.2,c={data:{type:"sales_invoices",attributes:{item_type:"invoice",description:`Patron Premium √úyelik - Sipari≈ü #${a}`,issue_date:new Date().toISOString().split("T")[0],due_date:new Date().toISOString().split("T")[0],currency:"TRL"},relationships:{contact:{data:{type:"contacts",id:e}},details:{data:[{type:"sales_invoice_details",attributes:{quantity:1,unit_price:n,vat_rate:20},relationships:{product:{data:{type:"products",id:s}}}}]}}}},d=await fetch(`https://api.parasut.com/v4/${i}/sales_invoices`,{method:"POST",headers:{Authorization:`Bearer ${t}`,"Content-Type":"application/json"},body:JSON.stringify(c)});if(!d.ok){let S=await d.text();throw console.error("Parasut create invoice error:",S),new Error("Failed to create invoice")}let u=await d.json();return console.log("Parasut: Created invoice:",u.data.id),u.data.id}async recordPayment(t,e,r,a){let{companyId:i}=this.config,s={data:{type:"payments",attributes:{date:new Date().toISOString().split("T")[0],amount:r,description:`PayTR √ñdeme - ${a}`},relationships:{payable:{data:{type:"sales_invoices",id:e}}}}},n=await fetch(`https://api.parasut.com/v4/${i}/payments`,{method:"POST",headers:{Authorization:`Bearer ${t}`,"Content-Type":"application/json"},body:JSON.stringify(s)});if(n.ok)console.log("Parasut: Payment recorded");else{let c=await n.text();console.error("Parasut record payment error:",c)}}async generateEArchive(t,e){let{companyId:r}=this.config,a={data:{type:"e_archives",relationships:{sales_invoice:{data:{type:"sales_invoices",id:e}}}}},i=await fetch(`https://api.parasut.com/v4/${r}/e_archives`,{method:"POST",headers:{Authorization:`Bearer ${t}`,"Content-Type":"application/json"},body:JSON.stringify(a)});if(!i.ok){let n=await i.text();throw console.error("Parasut generate e-archive error:",n),new Error("Failed to generate e-archive")}let s=await i.json();return console.log("Parasut: E-Archive created:",s.data.id),s.data.id}async getEArchivePdfUrl(t,e){let{companyId:r}=this.config,a=20,i=3e3;for(let s=0;s<a;s++){let n=await fetch(`https://api.parasut.com/v4/${r}/e_archives/${e}`,{headers:{Authorization:`Bearer ${t}`}});if(n.ok){let c=await n.json(),d=c.data.attributes.pdf_url;if(d)return console.log("Parasut: Got PDF URL"),d;let u=c.data.attributes.status;s%5===0&&console.log(`Parasut: E-Archive status: ${u}, attempt ${s+1}/${a}`)}await new Promise(c=>setTimeout(c,i))}return console.warn(`Parasut: PDF URL not available after ${a} attempts`),null}async getInvoicePrintUrl(t,e){let{companyId:r}=this.config;try{let a=await fetch(`https://api.parasut.com/v4/${r}/sales_invoices/${e}`,{headers:{Authorization:`Bearer ${t}`}});if(!a.ok)return console.error("Failed to get invoice:",a.status),null;let s=(await a.json()).data.attributes.print_url;return s?(console.log("Parasut: Got print URL"),s):null}catch(a){return console.error("Error getting invoice print URL:",a),null}}async createInvoice(t,e){try{let r=await this.getAccessToken(),a=t.totalAmount,i;e.invoiceType==="company"&&e.companyData?i=await this.createCompanyContact(r,e.companyData):i=await this.createMinimalContact(r);let s=await this.createSalesInvoice(r,i,a,t.merchantOid);await this.recordPayment(r,s,a,t.merchantOid);let n,c=null;try{n=await this.generateEArchive(r,s),n&&(c=await this.getEArchivePdfUrl(r,n))}catch(d){console.log("E-Archive generation failed:",d)}return{success:!0,invoiceId:s,eArchiveId:n,pdfUrl:c||void 0}}catch(r){return console.error("Parasut invoice creation failed:",r),{success:!1,error:r instanceof Error?r.message:"Unknown error"}}}};function w(){let o=process.env.PARASUT_CLIENT_ID,t=process.env.PARASUT_CLIENT_SECRET,e=process.env.PARASUT_USERNAME,r=process.env.PARASUT_PASSWORD,a=process.env.PARASUT_COMPANY_ID;return!o||!t||!e||!r||!a?(console.warn("Parasut: Missing configuration, service not available"),null):new y({clientId:o,clientSecret:t,username:e,password:r,companyId:a})}var l=process.env.WHATSAPP_PHONE_NUMBER_ID,g=process.env.WHATSAPP_ACCESS_TOKEN;async function A(o,t){if(!l||!g)return console.warn("WhatsApp: Missing credentials, cannot send message"),!1;try{let e=await fetch(`https://graph.facebook.com/v18.0/${l}/messages`,{method:"POST",headers:{Authorization:`Bearer ${g}`,"Content-Type":"application/json"},body:JSON.stringify({messaging_product:"whatsapp",to:o,type:"text",text:{body:t}})});if(!e.ok){let a=await e.json();return console.error("WhatsApp send message error:",a),!1}let r=await e.json();return console.log(`WhatsApp: Message sent to ${o}, id: ${r.messages?.[0]?.id}`),!0}catch(e){return console.error("WhatsApp send message failed:",e),!1}}async function C(o,t,e,r){if(!l||!g)return console.warn("WhatsApp: Missing credentials, cannot send document"),!1;try{let a=await fetch(`https://graph.facebook.com/v18.0/${l}/messages`,{method:"POST",headers:{Authorization:`Bearer ${g}`,"Content-Type":"application/json"},body:JSON.stringify({messaging_product:"whatsapp",to:o,type:"document",document:{link:t,caption:e,filename:r}})});if(!a.ok){let s=await a.json();return console.error("WhatsApp send document error:",s),!1}let i=await a.json();return console.log(`WhatsApp: Document sent to ${o}, id: ${i.messages?.[0]?.id}`),!0}catch(a){return console.error("WhatsApp send document failed:",a),!1}}async function P(o,t,e){let r=`Faturanƒ±z hazƒ±r!

Sipari≈ü No: ${e}

Patron Premium √ºyeliƒüiniz i√ßin te≈üekk√ºr ederiz. üôè`,a=`fatura-${e}.pdf`;return C(o,t,r,a)}async function v(o){return A(o,`‚úÖ √ñdemeniz ba≈üarƒ±yla alƒ±ndƒ±!

Premium √ºyeliƒüiniz aktif edildi. Artƒ±k t√ºm telefon numaralarƒ±nƒ± g√∂rebilirsiniz.

Sorularƒ±nƒ±z i√ßin WhatsApp'tan bize ula≈üabilirsiniz: +90 533 208 9867`)}async function b(o){return A(o,`‚ö†Ô∏è Faturanƒ±z ≈üu anda olu≈üturulamadƒ±.

Endi≈üelenmeyin, √∂demeniz ba≈üarƒ±lƒ± ve premium √ºyeliƒüiniz aktif. Faturanƒ±z en kƒ±sa s√ºrede manuel olarak olu≈üturulup g√∂nderilecektir.

Sorularƒ±nƒ±z i√ßin WhatsApp'tan bize ula≈üabilirsiniz: +90 533 208 9867`)}var N=new I.DynamoDBClient({}),h=p.DynamoDBDocumentClient.from(N),m=process.env.CONVERSATIONS_TABLE||"turkish-logistics-conversations";async function O(o){let{merchantOid:t,phoneNumber:e,totalAmount:r}=o;console.log(`Processing invoice for payment ${t}, phone ${e}, amount ${r}`);let a={invoiceType:"none"};try{let n=await h.send(new p.GetCommand({TableName:m,Key:{pk:`PAYMENT#${t}`,sk:"INVOICE_DATA"}}));if(n.Item){let c=n.Item;a={invoiceType:c.invoiceType,companyData:c.companyData},console.log(`Found invoice data: type=${a.invoiceType}`)}else console.log("No invoice data found, using minimal invoice")}catch(n){console.error("Error fetching invoice data:",n)}let i=w();if(!i){console.error("Parasut service not available, skipping invoice generation"),await v(e),await h.send(new p.UpdateCommand({TableName:m,Key:{pk:`PAYMENT#${t}`,sk:"PENDING"},UpdateExpression:"SET invoiceStatus = :status, invoiceError = :error, updatedAt = :now",ExpressionAttributeValues:{":status":"skipped",":error":"Parasut service not configured",":now":new Date().toISOString()}}));return}let s=await i.createInvoice({merchantOid:t,totalAmount:r},a);if(s.success){await v(e),console.log(`Payment success notification sent to ${e}`);let n="pending_pdf";if(s.pdfUrl){let c=await P(e,s.pdfUrl,t);n=c?"sent":"pdf_ready",console.log(`Invoice PDF ${c?"sent":"ready but not sent"} for ${t}`)}await h.send(new p.UpdateCommand({TableName:m,Key:{pk:`PAYMENT#${t}`,sk:"PENDING"},UpdateExpression:"SET invoiceStatus = :status, parasutInvoiceId = :invoiceId, parasutEArchiveId = :eArchiveId, invoicePdfUrl = :pdfUrl, phoneNumber = :phone, updatedAt = :now",ExpressionAttributeValues:{":status":n,":invoiceId":s.invoiceId,":eArchiveId":s.eArchiveId,":pdfUrl":s.pdfUrl||null,":phone":e,":now":new Date().toISOString()}})),console.log(`Invoice created for ${t}, status: ${n}`)}else throw console.error(`Invoice generation failed for ${t}:`,s.error),await b(e),await h.send(new p.UpdateCommand({TableName:m,Key:{pk:`PAYMENT#${t}`,sk:"PENDING"},UpdateExpression:"SET invoiceStatus = :status, invoiceError = :error, updatedAt = :now",ExpressionAttributeValues:{":status":"failed",":error":s.error||"Unknown error",":now":new Date().toISOString()}})),new Error(`Invoice generation failed: ${s.error}`)}async function D(o){let t=JSON.parse(o.body);if(!t.merchantOid||!t.phoneNumber||!t.totalAmount){console.error("Invalid invoice job message:",o.body);return}await O(t)}async function R(o){console.log(`Processing ${o.Records.length} invoice jobs`);let t=[];for(let e of o.Records)try{await D(e)}catch(r){console.error(`Failed to process record ${e.messageId}:`,r),t.push({itemIdentifier:e.messageId})}return{batchItemFailures:t}}0&&(module.exports={handler});
//# sourceMappingURL=index.js.map
