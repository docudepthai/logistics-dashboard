"use strict";var h=Object.defineProperty;var T=Object.getOwnPropertyDescriptor;var w=Object.getOwnPropertyNames;var P=Object.prototype.hasOwnProperty;var C=(e,n)=>{for(var s in n)h(e,s,{get:n[s],enumerable:!0})},O=(e,n,s,o)=>{if(n&&typeof n=="object"||typeof n=="function")for(let i of w(n))!P.call(e,i)&&i!==s&&h(e,i,{get:()=>n[i],enumerable:!(o=T(n,i))||o.enumerable});return e};var R=e=>O(h({},"__esModule",{value:!0}),e);var v={};C(v,{handler:()=>H});module.exports=R(v);var A=require("@aws-sdk/client-dynamodb"),g=require("@aws-sdk/lib-dynamodb"),$=new A.DynamoDBClient({}),y=g.DynamoDBDocumentClient.from($),N=process.env.CONVERSATIONS_TABLE||"turkish-logistics-conversations",S=process.env.WHATSAPP_PHONE_NUMBER_ID,b=process.env.WHATSAPP_ACCESS_TOKEN,m={mode:"manual",triggerHours:3,messageTemplate:'abi merhaba, dun kaydolmu\u015Ftun ama hic is aramadin. nasil calistigini gostereyim mi? ornek: "istanbul ankara" yaz, sana yukler gostereyim. bedava 7 gun, istersen dene.'};async function D(){try{let e=await y.send(new g.GetCommand({TableName:N,Key:{pk:"SETTINGS",sk:"NUDGE_CONFIG"}}));return e.Item?{mode:e.Item.mode||m.mode,triggerHours:e.Item.triggerHours??m.triggerHours,messageTemplate:e.Item.messageTemplate||m.messageTemplate}:m}catch(e){return console.error("Failed to fetch nudge settings:",e),m}}async function _(e,n){if(!S||!b)return console.error("WhatsApp credentials not configured"),!1;try{let o=await(await fetch(`https://graph.facebook.com/v18.0/${S}/messages`,{method:"POST",headers:{Authorization:`Bearer ${b}`,"Content-Type":"application/json"},body:JSON.stringify({messaging_product:"whatsapp",to:e,type:"text",text:{body:n}})})).json();return o.messages?.[0]?.id?(console.log(`\u2713 Message sent to ${e}, message_id: ${o.messages[0].id}`),!0):(console.error(`\u2717 Failed to send to ${e}:`,JSON.stringify(o)),!1)}catch(s){return console.error(`\u2717 Error sending to ${e}:`,s),!1}}async function k(e){await y.send(new g.UpdateCommand({TableName:N,Key:{pk:`USER#${e}`,sk:"CONVERSATION"},UpdateExpression:"SET nudgeSent = :sent, nudgeSentAt = :at",ExpressionAttributeValues:{":sent":!0,":at":new Date().toISOString()}}))}async function I(e){let n=[],s;do{let t=await y.send(new g.ScanCommand({TableName:N,ExclusiveStartKey:s}));n.push(...t.Items||[]),s=t.LastEvaluatedKey}while(s);let o=new Map;for(let t of n){let r=t.pk?.replace("USER#","");!r||!/^[+]?\d+$/.test(r)||r.length<10||t.sk==="CONVERSATION"&&o.set(r,t)}let i=Date.now(),u=[];for(let[t,r]of Array.from(o.entries())){let d=r.messages||[],c=r.context||{};if(r.nudgeSent===!0||c.lastOrigin||c.lastDestination)continue;let a=d.filter(E=>E.role==="user");if(a.length===0)continue;let l=a[a.length-1];if(!l)continue;let f=new Date(l.timestamp).getTime(),p=24-(i-f)/(1e3*60*60);p>0&&p<=e&&u.push({phoneNumber:t,hoursRemaining:p})}return u.sort((t,r)=>t.hoursRemaining-r.hoursRemaining),u}async function H(e){let n=Date.now();console.log("=== Auto-Nudge Lambda Started ==="),console.log("Event:",JSON.stringify(e));try{let s=await D();if(console.log(`Settings: mode=${s.mode}, triggerHours=${s.triggerHours}`),s.mode!=="automatic")return console.log("Automatic mode is disabled. Exiting."),{statusCode:200,body:JSON.stringify({message:"Automatic mode disabled",mode:s.mode})};let o=await I(s.triggerHours);if(console.log(`Found ${o.length} eligible users`),o.length===0)return{statusCode:200,body:JSON.stringify({message:"No eligible users to nudge",checked:!0})};let u=o.slice(0,10),t=[];for(let a of u){console.log(`Processing ${a.phoneNumber} (${a.hoursRemaining.toFixed(1)}h remaining)`),await k(a.phoneNumber);let l=await _(a.phoneNumber,s.messageTemplate);t.push({phoneNumber:a.phoneNumber,success:l,error:l?void 0:"Failed to send message"}),await new Promise(f=>setTimeout(f,500))}let r=t.filter(a=>a.success).length,d=t.filter(a=>!a.success).length,c=Date.now()-n;return console.log("=== Auto-Nudge Summary ==="),console.log(`Processed: ${t.length}`),console.log(`Successful: ${r}`),console.log(`Failed: ${d}`),console.log(`Remaining eligible: ${o.length-u.length}`),console.log(`Duration: ${c}ms`),{statusCode:200,body:JSON.stringify({message:"Auto-nudge completed",processed:t.length,successful:r,failed:d,remainingEligible:o.length-u.length,duration:c,results:t})}}catch(s){return console.error("Auto-nudge error:",s),{statusCode:500,body:JSON.stringify({error:"Auto-nudge failed",message:s instanceof Error?s.message:"Unknown error"})}}}0&&(module.exports={handler});
//# sourceMappingURL=index.js.map
