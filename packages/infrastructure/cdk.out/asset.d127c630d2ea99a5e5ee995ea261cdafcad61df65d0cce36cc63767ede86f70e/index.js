"use strict";var N=Object.defineProperty;var T=Object.getOwnPropertyDescriptor;var w=Object.getOwnPropertyNames;var O=Object.prototype.hasOwnProperty;var C=(s,t)=>{for(var e in t)N(s,e,{get:t[e],enumerable:!0})},P=(s,t,e,o)=>{if(t&&typeof t=="object"||typeof t=="function")for(let i of w(t))!O.call(s,i)&&i!==e&&N(s,i,{get:()=>t[i],enumerable:!(o=T(t,i))||o.enumerable});return s};var R=s=>P(N({},"__esModule",{value:!0}),s);var v={};C(v,{handler:()=>_});module.exports=R(v);var b=require("@aws-sdk/client-dynamodb"),u=require("@aws-sdk/lib-dynamodb"),$=new b.DynamoDBClient({}),p=u.DynamoDBDocumentClient.from($),f=process.env.CONVERSATIONS_TABLE||"turkish-logistics-conversations",S=process.env.WHATSAPP_PHONE_NUMBER_ID,A=process.env.WHATSAPP_ACCESS_TOKEN,m={mode:"manual",triggerHours:3,messageTemplate:'abi merhaba, dun kaydolmuştun ama hic is aramadin. nasil calistigini gostereyim mi? ornek: "istanbul ankara" yaz, sana yukler gostereyim. bedava 7 gun, istersen dene.'};async function k(){try{let s=await p.send(new u.GetCommand({TableName:f,Key:{pk:"SETTINGS",sk:"NUDGE_CONFIG"}}));return s.Item?{mode:s.Item.mode||m.mode,triggerHours:s.Item.triggerHours??m.triggerHours,messageTemplate:s.Item.messageTemplate||m.messageTemplate}:m}catch(s){return console.error("Failed to fetch nudge settings:",s),m}}async function I(s,t){if(!S||!A)return console.error("WhatsApp credentials not configured"),!1;try{let o=await(await fetch(`https://graph.facebook.com/v18.0/${S}/messages`,{method:"POST",headers:{Authorization:`Bearer ${A}`,"Content-Type":"application/json"},body:JSON.stringify({messaging_product:"whatsapp",to:s,type:"text",text:{body:t}})})).json();return o.messages?.[0]?.id?(console.log(`✓ Message sent to ${s}, message_id: ${o.messages[0].id}`),!0):(console.error(`✗ Failed to send to ${s}:`,JSON.stringify(o)),!1)}catch(e){return console.error(`✗ Error sending to ${s}:`,e),!1}}async function M(s,t){let e=new Date().toISOString(),i=(await p.send(new u.GetCommand({TableName:f,Key:{pk:`USER#${s}`,sk:"CONVERSATION"}}))).Item?.messages||[],g={role:"assistant",content:t,timestamp:e};await p.send(new u.UpdateCommand({TableName:f,Key:{pk:`USER#${s}`,sk:"CONVERSATION"},UpdateExpression:"SET nudgeSent = :sent, nudgeSentAt = :at, messages = :messages, updatedAt = :updatedAt",ExpressionAttributeValues:{":sent":!0,":at":e,":messages":[...i,g],":updatedAt":e}}))}async function D(s){let t=[],e;do{let n=await p.send(new u.ScanCommand({TableName:f,ExclusiveStartKey:e}));t.push(...n.Items||[]),e=n.LastEvaluatedKey}while(e);let o=new Map;for(let n of t){let r=n.pk?.replace("USER#","");!r||!/^[+]?\d+$/.test(r)||r.length<10||n.sk==="CONVERSATION"&&o.set(r,n)}let i=Date.now(),g=[];for(let[n,r]of Array.from(o.entries())){let d=r.messages||[],c=r.context||{};if(r.nudgeSent===!0||c.lastOrigin||c.lastDestination)continue;let a=d.filter(E=>E.role==="user");if(a.length===0)continue;let l=a[a.length-1];if(!l)continue;let h=new Date(l.timestamp).getTime(),y=24-(i-h)/(1e3*60*60);y>0&&y<=s&&g.push({phoneNumber:n,hoursRemaining:y})}return g.sort((n,r)=>n.hoursRemaining-r.hoursRemaining),g}async function _(s){let t=Date.now();console.log("=== Auto-Nudge Lambda Started ==="),console.log("Event:",JSON.stringify(s));try{let e=await k();if(console.log(`Settings: mode=${e.mode}, triggerHours=${e.triggerHours}`),e.mode!=="automatic")return console.log("Automatic mode is disabled. Exiting."),{statusCode:200,body:JSON.stringify({message:"Automatic mode disabled",mode:e.mode})};let o=await D(e.triggerHours);if(console.log(`Found ${o.length} eligible users`),o.length===0)return{statusCode:200,body:JSON.stringify({message:"No eligible users to nudge",checked:!0})};let g=o.slice(0,10),n=[];for(let a of g){console.log(`Processing ${a.phoneNumber} (${a.hoursRemaining.toFixed(1)}h remaining)`);let l=await I(a.phoneNumber,e.messageTemplate);await M(a.phoneNumber,e.messageTemplate),n.push({phoneNumber:a.phoneNumber,success:l,error:l?void 0:"Failed to send message"}),await new Promise(h=>setTimeout(h,500))}let r=n.filter(a=>a.success).length,d=n.filter(a=>!a.success).length,c=Date.now()-t;return console.log("=== Auto-Nudge Summary ==="),console.log(`Processed: ${n.length}`),console.log(`Successful: ${r}`),console.log(`Failed: ${d}`),console.log(`Remaining eligible: ${o.length-g.length}`),console.log(`Duration: ${c}ms`),{statusCode:200,body:JSON.stringify({message:"Auto-nudge completed",processed:n.length,successful:r,failed:d,remainingEligible:o.length-g.length,duration:c,results:n})}}catch(e){return console.error("Auto-nudge error:",e),{statusCode:500,body:JSON.stringify({error:"Auto-nudge failed",message:e instanceof Error?e.message:"Unknown error"})}}}0&&(module.exports={handler});
//# sourceMappingURL=index.js.map
