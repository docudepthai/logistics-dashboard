"use strict";var g=Object.defineProperty;var b=Object.getOwnPropertyDescriptor;var k=Object.getOwnPropertyNames;var S=Object.prototype.hasOwnProperty;var _=(c,t)=>{for(var e in t)g(c,e,{get:t[e],enumerable:!0})},$=(c,t,e,r)=>{if(t&&typeof t=="object"||typeof t=="function")for(let a of k(t))!S.call(c,a)&&a!==e&&g(c,a,{get:()=>t[a],enumerable:!(r=b(t,a))||r.enumerable});return c};var T=c=>$(g({},"__esModule",{value:!0}),c);var O={};_(O,{handler:()=>I});module.exports=T(O);var A=require("@aws-sdk/client-dynamodb"),u=require("@aws-sdk/lib-dynamodb");var h=class{accessToken=null;tokenExpiry=null;config;constructor(t){this.config=t}async getAccessToken(){if(this.accessToken&&this.tokenExpiry&&this.tokenExpiry>Date.now()+3e5)return this.accessToken;console.log("Parasut: Authenticating...");let t=await fetch("https://api.parasut.com/oauth/token",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({client_id:this.config.clientId,client_secret:this.config.clientSecret,username:this.config.username,password:this.config.password,grant_type:"password",redirect_uri:"urn:ietf:wg:oauth:2.0:oob"})});if(!t.ok){let r=await t.text();throw console.error("Parasut auth failed:",r),new Error("Failed to authenticate with Parasut")}let e=await t.json();return this.accessToken=e.access_token,this.tokenExpiry=Date.now()+(e.expires_in-300)*1e3,console.log("Parasut: Authenticated successfully"),this.accessToken}async createMinimalContact(t){let{companyId:e}=this.config;try{let n=await fetch(`https://api.parasut.com/v4/${e}/contacts?filter[name]=Muhtelif%20M%C3%BC%C5%9Fteriler`,{headers:{Authorization:`Bearer ${t}`}});if(n.ok){let i=(await n.json()).data?.[0];if(i)return console.log("Parasut: Found existing Muhtelif M√º≈üteriler contact"),i.id}}catch{}let r={data:{type:"contacts",attributes:{name:"Muhtelif M√º≈üteriler",contact_type:"person",account_type:"customer",tax_number:"11111111111"}}},a=await fetch(`https://api.parasut.com/v4/${e}/contacts`,{method:"POST",headers:{Authorization:`Bearer ${t}`,"Content-Type":"application/json"},body:JSON.stringify(r)});if(!a.ok){if(a.status===422){console.log("Parasut: Contact already exists, searching...");let o=await fetch(`https://api.parasut.com/v4/${e}/contacts?filter[name]=Muhtelif`,{headers:{Authorization:`Bearer ${t}`}});if(o.ok){let d=(await o.json()).data?.[0];if(d)return d.id}}let n=await a.text();throw console.error("Parasut create minimal contact error:",n),new Error("Failed to create minimal contact")}let s=await a.json();return console.log("Parasut: Created Muhtelif M√º≈üteriler contact:",s.data.id),s.data.id}async createCompanyContact(t,e){let{companyId:r}=this.config;try{let o=await fetch(`https://api.parasut.com/v4/${r}/contacts?filter[tax_number]=${e.vkn}`,{headers:{Authorization:`Bearer ${t}`}});if(o.ok){let d=(await o.json()).data?.[0];if(d)return console.log("Parasut: Found existing company contact by VKN"),d.id}}catch{}let a={data:{type:"contacts",attributes:{name:e.companyName,contact_type:"company",account_type:"customer",tax_office:e.taxOffice,tax_number:e.vkn,address:e.address,city:e.city,district:e.district,email:e.email||void 0,phone:e.phone||void 0}}},s=await fetch(`https://api.parasut.com/v4/${r}/contacts`,{method:"POST",headers:{Authorization:`Bearer ${t}`,"Content-Type":"application/json"},body:JSON.stringify(a)});if(!s.ok){if(s.status===422){let i=await fetch(`https://api.parasut.com/v4/${r}/contacts?filter[tax_number]=${e.vkn}`,{headers:{Authorization:`Bearer ${t}`}});if(i.ok){let p=(await i.json()).data?.[0];if(p)return p.id}}let o=await s.text();throw console.error("Parasut create company contact error:",o),new Error("Failed to create company contact")}let n=await s.json();return console.log("Parasut: Created company contact:",n.data.id),n.data.id}async getOrCreateProduct(t){let{companyId:e}=this.config,r="Patron Premium √úyelik (1 Ay)";try{let o=await fetch(`https://api.parasut.com/v4/${e}/products?filter[name]=${encodeURIComponent(r)}`,{headers:{Authorization:`Bearer ${t}`}});if(o.ok){let d=(await o.json()).data?.[0];if(d)return console.log("Parasut: Found existing product:",d.id),d.id}}catch{console.log("Parasut: Product search failed, will create new")}let a={data:{type:"products",attributes:{name:r,vat_rate:20,unit:"Adet",sales_price:1e3,currency:"TRL",product_type:"service"}}},s=await fetch(`https://api.parasut.com/v4/${e}/products`,{method:"POST",headers:{Authorization:`Bearer ${t}`,"Content-Type":"application/json"},body:JSON.stringify(a)});if(!s.ok){let o=await s.text();throw console.error("Parasut create product error:",o),new Error("Failed to create product")}let n=await s.json();return console.log("Parasut: Created product:",n.data.id),n.data.id}async createSalesInvoice(t,e,r,a){let{companyId:s}=this.config,n=await this.getOrCreateProduct(t),o=r/1.2,i={data:{type:"sales_invoices",attributes:{item_type:"invoice",description:`Patron Premium √úyelik - Sipari≈ü #${a}`,issue_date:new Date().toISOString().split("T")[0],due_date:new Date().toISOString().split("T")[0],currency:"TRL"},relationships:{contact:{data:{type:"contacts",id:e}},details:{data:[{type:"sales_invoice_details",attributes:{quantity:1,unit_price:o,vat_rate:20},relationships:{product:{data:{type:"products",id:n}}}}]}}}},d=await fetch(`https://api.parasut.com/v4/${s}/sales_invoices`,{method:"POST",headers:{Authorization:`Bearer ${t}`,"Content-Type":"application/json"},body:JSON.stringify(i)});if(!d.ok){let v=await d.text();throw console.error("Parasut create invoice error:",v),new Error("Failed to create invoice")}let p=await d.json();return console.log("Parasut: Created invoice:",p.data.id),p.data.id}async recordPayment(t,e,r,a){let{companyId:s}=this.config,n={data:{type:"payments",attributes:{date:new Date().toISOString().split("T")[0],amount:r,description:`PayTR √ñdeme - ${a}`},relationships:{payable:{data:{type:"sales_invoices",id:e}}}}},o=await fetch(`https://api.parasut.com/v4/${s}/payments`,{method:"POST",headers:{Authorization:`Bearer ${t}`,"Content-Type":"application/json"},body:JSON.stringify(n)});if(o.ok)console.log("Parasut: Payment recorded");else{let i=await o.text();console.error("Parasut record payment error:",i)}}async generateEArchive(t,e){let{companyId:r}=this.config,a={data:{type:"e_archives",relationships:{sales_invoice:{data:{type:"sales_invoices",id:e}}}}},s=await fetch(`https://api.parasut.com/v4/${r}/e_archives`,{method:"POST",headers:{Authorization:`Bearer ${t}`,"Content-Type":"application/json"},body:JSON.stringify(a)});if(!s.ok){let o=await s.text();throw console.error("Parasut generate e-archive error:",o),new Error("Failed to generate e-archive")}let n=await s.json();return console.log("Parasut: E-Archive created:",n.data.id),n.data.id}async getEArchivePdfUrl(t,e){let{companyId:r}=this.config,a=20,s=3e3;for(let n=0;n<a;n++){let o=await fetch(`https://api.parasut.com/v4/${r}/e_archives/${e}`,{headers:{Authorization:`Bearer ${t}`}});if(o.ok){let i=await o.json(),d=i.data.attributes.pdf_url;if(d)return console.log("Parasut: Got PDF URL"),d;let p=i.data.attributes.status;n%5===0&&console.log(`Parasut: E-Archive status: ${p}, attempt ${n+1}/${a}`)}await new Promise(i=>setTimeout(i,s))}return console.warn(`Parasut: PDF URL not available after ${a} attempts`),null}async getInvoicePrintUrl(t,e){let{companyId:r}=this.config;try{let a=await fetch(`https://api.parasut.com/v4/${r}/sales_invoices/${e}`,{headers:{Authorization:`Bearer ${t}`}});if(!a.ok)return console.error("Failed to get invoice:",a.status),null;let n=(await a.json()).data.attributes.print_url;return n?(console.log("Parasut: Got print URL"),n):null}catch(a){return console.error("Error getting invoice print URL:",a),null}}async createInvoice(t,e){try{let r=await this.getAccessToken(),a=t.totalAmount,s;e.invoiceType==="company"&&e.companyData?s=await this.createCompanyContact(r,e.companyData):s=await this.createMinimalContact(r);let n=await this.createSalesInvoice(r,s,a,t.merchantOid);await this.recordPayment(r,n,a,t.merchantOid);let o,i=null;try{o=await this.generateEArchive(r,n),o&&(i=await this.getEArchivePdfUrl(r,o))}catch(d){console.log("E-Archive generation failed:",d)}return{success:!0,invoiceId:n,eArchiveId:o,pdfUrl:i||void 0}}catch(r){return console.error("Parasut invoice creation failed:",r),{success:!1,error:r instanceof Error?r.message:"Unknown error"}}}};function f(){let c=process.env.PARASUT_CLIENT_ID,t=process.env.PARASUT_CLIENT_SECRET,e=process.env.PARASUT_USERNAME,r=process.env.PARASUT_PASSWORD,a=process.env.PARASUT_COMPANY_ID;return!c||!t||!e||!r||!a?(console.warn("Parasut: Missing configuration, service not available"),null):new h({clientId:c,clientSecret:t,username:e,password:r,companyId:a})}var y=process.env.WHATSAPP_PHONE_NUMBER_ID,w=process.env.WHATSAPP_ACCESS_TOKEN;async function E(c,t,e,r){if(!y||!w)return console.warn("WhatsApp: Missing credentials, cannot send document"),!1;try{let a=await fetch(`https://graph.facebook.com/v18.0/${y}/messages`,{method:"POST",headers:{Authorization:`Bearer ${w}`,"Content-Type":"application/json"},body:JSON.stringify({messaging_product:"whatsapp",to:c,type:"document",document:{link:t,caption:e,filename:r}})});if(!a.ok){let n=await a.json();return console.error("WhatsApp send document error:",n),!1}let s=await a.json();return console.log(`WhatsApp: Document sent to ${c}, id: ${s.messages?.[0]?.id}`),!0}catch(a){return console.error("WhatsApp send document failed:",a),!1}}async function P(c,t,e){let r=`Faturanƒ±z hazƒ±r!

Sipari≈ü No: ${e}

Patron Premium √ºyeliƒüiniz i√ßin te≈üekk√ºr ederiz. üôè`,a=`fatura-${e}.pdf`;return E(c,t,r,a)}var x=new A.DynamoDBClient({}),m=u.DynamoDBDocumentClient.from(x),l=process.env.CONVERSATIONS_TABLE||"turkish-logistics-conversations";async function C(c){let t=f();if(!t)return console.log("Parasut service not available"),null;try{let e=await t.getAccessToken(),r=process.env.PARASUT_COMPANY_ID,a=await fetch(`https://api.parasut.com/v4/${r}/e_archives/${c}`,{headers:{Authorization:`Bearer ${e}`}});if(!a.ok)return console.log(`Failed to get e-archive ${c}: ${a.status}`),null;let s=await a.json(),n=s.data.attributes.pdf_url,o=s.data.attributes.status;return console.log(`E-Archive ${c}: status=${o}, pdf_url=${n?"available":"not available"}`),n||null}catch(e){return console.error(`Error checking e-archive ${c}:`,e),null}}async function I(){console.log("Starting PDF check..."),console.log(`Using table: ${l}`);let c=[],t,e=0;do{let s=await m.send(new u.ScanCommand({TableName:l,FilterExpression:"invoiceStatus = :status",ExpressionAttributeValues:{":status":"pending_pdf"},ExclusiveStartKey:t}));e+=s.ScannedCount||0,c.push(...s.Items||[]),t=s.LastEvaluatedKey}while(t);console.log(`Scanned ${e} items total, found ${c.length} pending PDF records`),c.length>0&&console.log("Records:",JSON.stringify(c.map(s=>({pk:s.pk,phone:s.phoneNumber}))));let r=0,a=0;for(let s of c){r++;let n=s.pk.replace("PAYMENT#","");if(!s.parasutEArchiveId||!s.phoneNumber){console.log(`Skipping ${n}: missing eArchiveId or phoneNumber`);continue}let o=await C(s.parasutEArchiveId);if(o){console.log(`Sending PDF to ${s.phoneNumber} for ${n}`);let i=await P(s.phoneNumber,o,n);await m.send(new u.UpdateCommand({TableName:l,Key:{pk:s.pk,sk:s.sk},UpdateExpression:"SET invoiceStatus = :status, invoicePdfUrl = :pdfUrl, invoiceSentAt = :sentAt, updatedAt = :now",ExpressionAttributeValues:{":status":i?"sent":"pdf_ready",":pdfUrl":o,":sentAt":i?new Date().toISOString():null,":now":new Date().toISOString()}})),i&&a++,console.log(`PDF ${i?"sent":"ready but not sent"} for ${n}`)}else{let i=s.createdAt?new Date(s.createdAt):new Date,d=Date.now()-i.getTime(),p=60*60*1e3;d>p&&(console.log(`Record ${n} too old (${Math.round(d/6e4)}min), marking as failed`),await m.send(new u.UpdateCommand({TableName:l,Key:{pk:s.pk,sk:s.sk},UpdateExpression:"SET invoiceStatus = :status, invoiceError = :error, updatedAt = :now",ExpressionAttributeValues:{":status":"pdf_timeout",":error":"PDF not available after 1 hour",":now":new Date().toISOString()}})))}await new Promise(i=>setTimeout(i,500))}return console.log(`PDF check complete: processed=${r}, sent=${a}`),{processed:r,sent:a}}0&&(module.exports={handler});
//# sourceMappingURL=index.js.map
