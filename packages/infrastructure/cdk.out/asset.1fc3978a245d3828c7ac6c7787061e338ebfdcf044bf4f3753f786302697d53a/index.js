"use strict";var i=Object.defineProperty;var f=Object.getOwnPropertyDescriptor;var A=Object.getOwnPropertyNames;var b=Object.prototype.hasOwnProperty;var P=(t,e)=>{for(var n in e)i(t,n,{get:e[n],enumerable:!0})},v=(t,e,n,r)=>{if(e&&typeof e=="object"||typeof e=="function")for(let s of A(e))!b.call(t,s)&&s!==n&&i(t,s,{get:()=>e[s],enumerable:!(r=f(e,s))||r.enumerable});return t};var w=t=>v(i({},"__esModule",{value:!0}),t);var k={};P(k,{handler:()=>S});module.exports=w(k);var h=require("@aws-sdk/client-dynamodb"),o=require("@aws-sdk/lib-dynamodb");var d=process.env.WHATSAPP_PHONE_NUMBER_ID,l=process.env.WHATSAPP_ACCESS_TOKEN;async function N(t,e,n,r){if(!d||!l)return console.warn("WhatsApp: Missing credentials, cannot send document"),!1;try{let s=await fetch(`https://graph.facebook.com/v18.0/${d}/messages`,{method:"POST",headers:{Authorization:`Bearer ${l}`,"Content-Type":"application/json"},body:JSON.stringify({messaging_product:"whatsapp",to:t,type:"document",document:{link:e,caption:n,filename:r}})});if(!s.ok){let y=await s.json();return console.error("WhatsApp send document error:",y),!1}let a=await s.json();return console.log(`WhatsApp: Document sent to ${t}, id: ${a.messages?.[0]?.id}`),!0}catch(s){return console.error("WhatsApp send document failed:",s),!1}}async function u(t,e,n){let r=`Faturanƒ±z hazƒ±r!

Sipari≈ü No: ${n}

Patron Premium √ºyeliƒüiniz i√ßin te≈üekk√ºr ederiz. üôè`,s=`fatura-${n}.pdf`;return N(t,e,r,s)}var I=new h.DynamoDBClient({}),c=o.DynamoDBDocumentClient.from(I),p=process.env.CONVERSATIONS_TABLE||"turkish-logistics-conversations";async function W(t){try{let n=(await c.send(new o.QueryCommand({TableName:p,IndexName:"parasutEArchiveId-index",KeyConditionExpression:"parasutEArchiveId = :eArchiveId",ExpressionAttributeValues:{":eArchiveId":t}}))).Items?.[0];if(n)return{merchantOid:n.pk.replace("PAYMENT#",""),phoneNumber:n.phoneNumber}}catch(e){console.log("GSI lookup failed, trying scan:",e)}return null}async function E(t){try{let n=(await c.send(new o.QueryCommand({TableName:p,IndexName:"parasutInvoiceId-index",KeyConditionExpression:"parasutInvoiceId = :invoiceId",ExpressionAttributeValues:{":invoiceId":t}}))).Items?.[0];if(n)return{merchantOid:n.pk.replace("PAYMENT#",""),phoneNumber:n.phoneNumber}}catch(e){console.log("GSI lookup failed:",e)}return null}async function g(t){let e=t.data.id,n=t.data.attributes?.pdf_url;if(console.log(`E-Archive event for ${e}, PDF URL: ${n?"available":"not available"}`),!n){console.log("No PDF URL in webhook payload, skipping");return}let r=await W(e);if(!r){console.log(`No payment found for e-archive ${e}`);let s=t.data.relationships?.sales_invoice?.data?.id;if(s){let a=await E(s);if(a){await m(a,e,n);return}}return}await m(r,e,n)}async function m(t,e,n){let{merchantOid:r,phoneNumber:s}=t;console.log(`Sending PDF to ${s} for payment ${r}`);let a=await u(s,n,r);await c.send(new o.UpdateCommand({TableName:p,Key:{pk:`PAYMENT#${r}`,sk:"PENDING"},UpdateExpression:"SET invoiceStatus = :status, invoicePdfUrl = :pdfUrl, invoiceSentAt = :sentAt, updatedAt = :now",ExpressionAttributeValues:{":status":a?"sent":"pdf_ready",":pdfUrl":n,":sentAt":a?new Date().toISOString():null,":now":new Date().toISOString()}})),console.log(`PDF ${a?"sent":"not sent"} for payment ${r}`)}async function S(t){console.log("Parasut webhook received:",t.body);try{let e=JSON.parse(t.body||"{}");if(!e.event||!e.data)return console.error("Invalid webhook payload"),{statusCode:400,body:JSON.stringify({error:"Invalid payload"})};switch(console.log(`Processing Parasut event: ${e.event}, type: ${e.data.type}`),e.event){case"e_archive.created":case"e_archive.updated":await g(e);break;case"e_invoice.created":case"e_invoice.updated":await g(e);break;default:console.log(`Unhandled event type: ${e.event}`)}return{statusCode:200,body:JSON.stringify({success:!0})}}catch(e){return console.error("Error processing Parasut webhook:",e),{statusCode:500,body:JSON.stringify({error:"Internal server error"})}}}0&&(module.exports={handler});
//# sourceMappingURL=index.js.map
