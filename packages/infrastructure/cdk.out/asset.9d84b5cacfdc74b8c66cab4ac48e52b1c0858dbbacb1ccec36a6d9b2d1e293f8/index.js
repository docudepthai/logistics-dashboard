"use strict";var d=Object.defineProperty;var E=Object.getOwnPropertyDescriptor;var R=Object.getOwnPropertyNames;var k=Object.prototype.hasOwnProperty;var I=(e,t)=>{for(var s in t)d(e,s,{get:t[s],enumerable:!0})},b=(e,t,s,o)=>{if(t&&typeof t=="object"||typeof t=="function")for(let n of R(t))!k.call(e,n)&&n!==s&&d(e,n,{get:()=>t[n],enumerable:!(o=E(t,n))||o.enumerable});return e};var C=e=>b(d({},"__esModule",{value:!0}),e);var $={};I($,{handler:()=>D});module.exports=C($);var T=require("crypto"),f=require("@aws-sdk/client-dynamodb"),a=require("@aws-sdk/lib-dynamodb"),O=new f.DynamoDBClient({}),c=a.DynamoDBDocumentClient.from(O),u=process.env.CONVERSATIONS_TABLE||"turkish-logistics-conversations",p=process.env.PAYTR_MERCHANT_ID||"",y=process.env.PAYTR_MERCHANT_KEY||"",_=process.env.PAYTR_MERCHANT_SALT||"",i=process.env.SUBSCRIPTION_PRICE||"100000",N=30;function h(e,t){return{statusCode:e,headers:{"Content-Type":"application/json","Access-Control-Allow-Origin":"*"},body:JSON.stringify(t)}}async function x(e,t){if(!p||!y||!_)return{success:!1,error:"PayTR credentials not configured"};let s=`${e}_${Date.now()}`,o=`${e}@whatsapp.logistics.local`,n=e,w=e.startsWith("90")?e:`90${e}`,g=[["Lojistik Bot Premium Uyelik (1 Ay)",(parseInt(i)/100).toFixed(2),1]],P=Buffer.from(JSON.stringify(g)).toString("base64"),A=p+t+s+o+i+P+"00TL0",S=(0,T.createHmac)("sha256",y).update(A+_).digest("base64"),l=process.env.PAYMENT_WEBHOOK_URL||"https://t50lrx3amk.execute-api.eu-central-1.amazonaws.com/prod/payment";try{let m=new URLSearchParams({merchant_id:p,user_ip:t,merchant_oid:s,email:o,payment_amount:i,paytr_token:S,user_basket:P,debug_on:"0",no_installment:"1",max_installment:"0",user_name:n,user_address:"Turkey",user_phone:w,merchant_ok_url:`${l}?status=ok&phone=${e}`,merchant_fail_url:`${l}?status=fail&phone=${e}`,merchant_notify_url:l,timeout_limit:"30",currency:"TL",test_mode:"0",lang:"tr"}),r=await(await fetch("https://www.paytr.com/odeme/api/get-token",{method:"POST",headers:{"Content-Type":"application/x-www-form-urlencoded"},body:m.toString()})).json();return r.status==="success"&&r.token?(await c.send(new a.UpdateCommand({TableName:u,Key:{pk:`PAYMENT#${s}`,sk:"PENDING"},UpdateExpression:"SET phoneNumber = :phone, amount = :amount, createdAt = :now, #s = :status",ExpressionAttributeNames:{"#s":"status"},ExpressionAttributeValues:{":phone":e,":amount":parseInt(i)/100,":now":new Date().toISOString(),":status":"pending"}})),{success:!0,paymentUrl:`https://www.paytr.com/odeme/guvenli/${r.token}`}):(console.error("PayTR token error:",r.reason),{success:!1,error:r.reason||"Token generation failed"})}catch(m){return console.error("PayTR API error:",m),{success:!1,error:"Payment service unavailable"}}}async function U(e){console.log("PayTR webhook received:",e);let t=e.merchant_oid+_+e.status+e.total_amount;if((0,T.createHmac)("sha256",y).update(t).digest("base64")!==e.hash)return console.error("PayTR hash verification failed"),!1;let o=e.merchant_oid.split("_")[0];if(e.status==="success"){let n=new Date;return n.setDate(n.getDate()+N),await c.send(new a.UpdateCommand({TableName:u,Key:{pk:`USER#${o}`,sk:"PROFILE"},UpdateExpression:"SET membershipStatus = :status, paidUntil = :paidUntil, paymentId = :paymentId, updatedAt = :now",ExpressionAttributeValues:{":status":"premium",":paidUntil":n.toISOString(),":paymentId":e.merchant_oid,":now":new Date().toISOString()}})),await c.send(new a.UpdateCommand({TableName:u,Key:{pk:`PAYMENT#${e.merchant_oid}`,sk:"PENDING"},UpdateExpression:"SET #s = :status, paidAt = :now, totalAmount = :amount",ExpressionAttributeNames:{"#s":"status"},ExpressionAttributeValues:{":status":"success",":now":new Date().toISOString(),":amount":parseInt(e.total_amount)/100}})),console.log(`User ${o} upgraded to premium until ${n.toISOString()}`),!0}else return console.log(`Payment failed for ${o}: ${e.failed_reason_msg}`),await c.send(new a.UpdateCommand({TableName:u,Key:{pk:`PAYMENT#${e.merchant_oid}`,sk:"PENDING"},UpdateExpression:"SET #s = :status, failedAt = :now, failReason = :reason",ExpressionAttributeNames:{"#s":"status"},ExpressionAttributeValues:{":status":"failed",":now":new Date().toISOString(),":reason":e.failed_reason_msg||"Unknown error"}})),!0}async function D(e){if(console.log("Payment handler:",e.httpMethod,e.path),e.httpMethod==="OPTIONS")return{statusCode:200,headers:{"Access-Control-Allow-Origin":"*","Access-Control-Allow-Methods":"GET, POST, OPTIONS","Access-Control-Allow-Headers":"Content-Type"},body:""};if(e.httpMethod==="GET"&&e.queryStringParameters?.phone){let t=e.queryStringParameters.phone,s=e.requestContext.identity?.sourceIp||"127.0.0.1",o=await x(t,s);return o.success?h(200,{success:!0,paymentUrl:o.paymentUrl,message:"Odeme linki olusturuldu"}):h(500,{success:!1,error:o.error})}if(e.httpMethod==="POST")try{let t=e.isBase64Encoded?Buffer.from(e.body||"","base64").toString("utf-8"):e.body||"",s=new URLSearchParams(t),o={merchant_oid:s.get("merchant_oid")||"",status:s.get("status")||"failed",total_amount:s.get("total_amount")||"0",hash:s.get("hash")||"",failed_reason_msg:s.get("failed_reason_msg")||void 0},n=await U(o);return{statusCode:200,headers:{"Content-Type":"text/plain"},body:"OK"}}catch(t){return console.error("Webhook error:",t),{statusCode:200,headers:{"Content-Type":"text/plain"},body:"OK"}}return h(405,{error:"Method not allowed"})}0&&(module.exports={handler});
//# sourceMappingURL=index.js.map
