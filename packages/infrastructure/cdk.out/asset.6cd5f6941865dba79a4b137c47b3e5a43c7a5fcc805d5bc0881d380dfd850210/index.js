"use strict";var b=Object.defineProperty;var x=Object.getOwnPropertyDescriptor;var N=Object.getOwnPropertyNames;var U=Object.prototype.hasOwnProperty;var D=(e,s)=>{for(var n in s)b(e,n,{get:s[n],enumerable:!0})},M=(e,s,n,t)=>{if(s&&typeof s=="object"||typeof s=="function")for(let o of N(s))!U.call(e,o)&&o!==n&&b(e,o,{get:()=>s[o],enumerable:!(t=x(s,o))||t.enumerable});return e};var $=e=>M(b({},"__esModule",{value:!0}),e);var K={};D(K,{handler:()=>v});module.exports=$(K);var k=require("crypto"),R=require("@aws-sdk/client-dynamodb"),r=require("@aws-sdk/lib-dynamodb"),h=require("@aws-sdk/client-sqs"),B=new h.SQSClient({}),I=process.env.INVOICE_QUEUE_URL,L=new R.DynamoDBClient({}),d=r.DynamoDBDocumentClient.from(L),m=process.env.CONVERSATIONS_TABLE||"turkish-logistics-conversations",l=process.env.PAYTR_MERCHANT_ID||"",S=process.env.PAYTR_MERCHANT_KEY||"",E=process.env.PAYTR_MERCHANT_SALT||"",c=process.env.SUBSCRIPTION_PRICE||"120000",Y=30;function G(e,s){return{statusCode:e,headers:{"Content-Type":"application/json","Access-Control-Allow-Origin":"*"},body:JSON.stringify(s)}}async function H(e,s){if(!l||!S||!E)return{success:!1,error:"PayTR credentials not configured"};let n=`${e}${Date.now()}`,t=`${e}@whatsapp.logistics.local`,o=e,a=e.startsWith("90")?e:`90${e}`,C=[["Lojistik Bot Premium Uyelik (1 Ay)",(parseInt(c)/100).toFixed(2),1]],p=Buffer.from(JSON.stringify(C)).toString("base64"),y="0",g="0",f="TL",u="0",A=l+s+n+t+c+p+y+g+f+u;console.log("Hash components:",{merchant_id:l,user_ip:s,merchant_oid:n,email:t,payment_amount:c,user_basket:p,no_installment:y,max_installment:g,currency:f,test_mode:u,hashStr_length:A.length});let O=(0,k.createHmac)("sha256",S).update(A+E).digest("base64");console.log("Generated token length:",O.length);let _=process.env.PAYMENT_WEBHOOK_URL||"https://pay.patron.ankago.com/payment";try{let T=new URLSearchParams({merchant_id:l,user_ip:s,merchant_oid:n,email:t,payment_amount:c,paytr_token:O,user_basket:p,debug_on:u,no_installment:y,max_installment:g,user_name:o,user_address:"Turkey",user_phone:a,merchant_ok_url:`${_}?status=ok&phone=${e}`,merchant_fail_url:`${_}?status=fail&phone=${e}`,merchant_notify_url:_,timeout_limit:"30",currency:f,test_mode:u,lang:"tr"});console.log("PayTR request:",{merchant_id:l,merchant_oid:n,payment_amount:c,email:t,user_ip:s});let P=await fetch("https://www.paytr.com/odeme/api/get-token",{method:"POST",headers:{"Content-Type":"application/x-www-form-urlencoded"},body:T.toString()});console.log("PayTR response status:",P.status,P.statusText);let w=await P.text();console.log("PayTR raw response:",w||"(empty)");let i;try{i=JSON.parse(w)}catch{return console.error("Failed to parse PayTR response:",w),{success:!1,error:"Invalid response from payment service"}}return i.status==="success"&&i.token?(await d.send(new r.UpdateCommand({TableName:m,Key:{pk:`PAYMENT#${n}`,sk:"PENDING"},UpdateExpression:"SET phoneNumber = :phone, amount = :amount, createdAt = :now, #s = :status",ExpressionAttributeNames:{"#s":"status"},ExpressionAttributeValues:{":phone":e,":amount":parseInt(c)/100,":now":new Date().toISOString(),":status":"pending"}})),{success:!0,paymentUrl:`https://www.paytr.com/odeme/guvenli/${i.token}`}):(console.error("PayTR token error:",i.reason),{success:!1,error:i.reason||"Token generation failed"})}catch(T){return console.error("PayTR API error:",T),{success:!1,error:"Payment service unavailable"}}}async function q(e){console.log("PayTR webhook received:",JSON.stringify(e,null,2));let s=e.merchant_oid+E+e.status+e.total_amount,n=(0,k.createHmac)("sha256",S).update(s).digest("base64");if(console.log("Hash verification:",{received:e.hash,calculated:n,match:n===e.hash}),n!==e.hash)return console.error("PayTR hash verification failed"),!1;let t;try{t=(await d.send(new r.GetCommand({TableName:m,Key:{pk:`PAYMENT#${e.merchant_oid}`,sk:"PENDING"}}))).Item?.phoneNumber,console.log("Found phone from payment record:",t)}catch(o){console.error("Error looking up payment record:",o)}if(!t){let o=e.merchant_oid.match(/^(\d{10,12})/);if(o&&o[1]){let a=o[1];a.startsWith("90")&&a.length>=12?t=a.substring(0,12):a.startsWith("1")&&a.length>=11?t=a.substring(0,11):t=a}else t=e.merchant_oid.substring(0,11);console.log("Extracted phone from merchantOid:",t)}if(e.status==="success"){let o=new Date;if(o.setDate(o.getDate()+Y),await d.send(new r.UpdateCommand({TableName:m,Key:{pk:`USER#${t}`,sk:"PROFILE"},UpdateExpression:"SET membershipStatus = :status, paidUntil = :paidUntil, paymentId = :paymentId, updatedAt = :now",ExpressionAttributeValues:{":status":"premium",":paidUntil":o.toISOString(),":paymentId":e.merchant_oid,":now":new Date().toISOString()}})),await d.send(new r.UpdateCommand({TableName:m,Key:{pk:`PAYMENT#${e.merchant_oid}`,sk:"PENDING"},UpdateExpression:"SET #s = :status, paidAt = :now, totalAmount = :amount",ExpressionAttributeNames:{"#s":"status"},ExpressionAttributeValues:{":status":"success",":now":new Date().toISOString(),":amount":parseInt(e.total_amount)/100}})),console.log(`User ${t} upgraded to premium until ${o.toISOString()}`),I)try{await B.send(new h.SendMessageCommand({QueueUrl:I,MessageBody:JSON.stringify({merchantOid:e.merchant_oid,phoneNumber:t,totalAmount:parseInt(e.total_amount)/100,paidAt:new Date().toISOString()}),MessageGroupId:t,MessageDeduplicationId:e.merchant_oid})),console.log(`Invoice job queued for ${e.merchant_oid}`)}catch(a){console.error("Failed to queue invoice job:",a)}else console.log("INVOICE_QUEUE_URL not configured, skipping invoice generation");return!0}else return console.log(`Payment failed for ${t}: ${e.failed_reason_msg}`),await d.send(new r.UpdateCommand({TableName:m,Key:{pk:`PAYMENT#${e.merchant_oid}`,sk:"PENDING"},UpdateExpression:"SET #s = :status, failedAt = :now, failReason = :reason",ExpressionAttributeNames:{"#s":"status"},ExpressionAttributeValues:{":status":"failed",":now":new Date().toISOString(),":reason":e.failed_reason_msg||"Unknown error"}})),!0}async function v(e){if(console.log("Payment handler:",e.httpMethod,e.path,e.queryStringParameters),e.httpMethod==="POST"&&(console.log("POST body:",e.body?.substring(0,500)),console.log("POST headers:",JSON.stringify(e.headers,null,2))),e.httpMethod==="OPTIONS")return{statusCode:200,headers:{"Access-Control-Allow-Origin":"*","Access-Control-Allow-Methods":"GET, POST, OPTIONS","Access-Control-Allow-Headers":"Content-Type"},body:""};if(e.httpMethod==="GET"&&e.queryStringParameters?.status==="ok"){let s=e.queryStringParameters.phone||"";return{statusCode:200,headers:{"Content-Type":"text/html; charset=utf-8"},body:`<!DOCTYPE html>
<html><head><meta charset="utf-8"><title>Odeme Basarili</title>
<meta name="viewport" content="width=device-width, initial-scale=1">
<style>body{font-family:sans-serif;text-align:center;padding:50px;background:#f0fff0;}</style></head>
<body>
<h1 style="color:green;">✅ Odeme Basarili!</h1>
<p>Tebrikler! Premium uyeliginiz aktif edildi.</p>
<p>Artik tum telefon numaralarini gorebilirsiniz.</p>
<p style="margin-top:30px;color:#666;">WhatsApp'a donup yuk aramaya devam edebilirsiniz.</p>
</body></html>`}}if(e.httpMethod==="GET"&&e.queryStringParameters?.status==="fail"){let n=`https://pay.patron.ankago.com/payment?phone=${e.queryStringParameters.phone||""}`;return{statusCode:200,headers:{"Content-Type":"text/html; charset=utf-8"},body:`<!DOCTYPE html>
<html><head><meta charset="utf-8"><title>Odeme Basarisiz</title>
<meta name="viewport" content="width=device-width, initial-scale=1">
<style>body{font-family:sans-serif;text-align:center;padding:50px;background:#fff0f0;}</style></head>
<body>
<h1 style="color:red;">❌ Odeme Basarisiz</h1>
<p>Odeme islemi tamamlanamadi.</p>
<p>Lutfen tekrar deneyin veya farkli bir kart kullanin.</p>
<p style="margin-top:30px;"><a href="${n}" style="background:#007bff;color:white;padding:15px 30px;text-decoration:none;border-radius:5px;">Tekrar Dene</a></p>
</body></html>`}}if(e.httpMethod==="GET"&&e.queryStringParameters?.phone){let s=e.queryStringParameters.phone,n=e.requestContext.identity?.sourceIp||"127.0.0.1",t=await H(s,n);return t.success&&t.paymentUrl?{statusCode:302,headers:{Location:t.paymentUrl,"Cache-Control":"no-cache, no-store, must-revalidate"},body:""}:{statusCode:500,headers:{"Content-Type":"text/html; charset=utf-8"},body:`<!DOCTYPE html>
<html><head><title>Odeme Hatasi</title></head>
<body style="font-family: sans-serif; text-align: center; padding: 50px;">
<h1>Odeme Baslatilamadi</h1>
<p>Hata: ${t.error||"Bilinmeyen hata"}</p>
<p>Lutfen tekrar deneyin veya destek ile iletisime gecin.</p>
</body></html>`}}if(e.httpMethod==="POST")try{let s=e.isBase64Encoded?Buffer.from(e.body||"","base64").toString("utf-8"):e.body||"",n=new URLSearchParams(s),t={merchant_oid:n.get("merchant_oid")||"",status:n.get("status")||"failed",total_amount:n.get("total_amount")||"0",hash:n.get("hash")||"",failed_reason_msg:n.get("failed_reason_msg")||void 0},o=await q(t);return{statusCode:200,headers:{"Content-Type":"text/plain"},body:"OK"}}catch(s){return console.error("Webhook error:",s),{statusCode:200,headers:{"Content-Type":"text/plain"},body:"OK"}}return G(405,{error:"Method not allowed"})}0&&(module.exports={handler});
//# sourceMappingURL=index.js.map
