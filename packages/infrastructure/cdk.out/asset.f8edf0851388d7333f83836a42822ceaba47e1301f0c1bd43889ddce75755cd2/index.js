"use strict";var h=Object.defineProperty;var b=Object.getOwnPropertyDescriptor;var k=Object.getOwnPropertyNames;var _=Object.prototype.hasOwnProperty;var $=(c,a)=>{for(var t in a)h(c,t,{get:a[t],enumerable:!0})},S=(c,a,t,e)=>{if(a&&typeof a=="object"||typeof a=="function")for(let s of k(a))!_.call(c,s)&&s!==t&&h(c,s,{get:()=>a[s],enumerable:!(e=b(a,s))||e.enumerable});return c};var T=c=>S(h({},"__esModule",{value:!0}),c);var N={};$(N,{handler:()=>D});module.exports=T(N);var A=require("@aws-sdk/client-dynamodb"),p=require("@aws-sdk/lib-dynamodb");var f=class{accessToken=null;tokenExpiry=null;config;constructor(a){this.config=a}async getAccessToken(){if(this.accessToken&&this.tokenExpiry&&this.tokenExpiry>Date.now()+3e5)return this.accessToken;console.log("Parasut: Authenticating...");let a=await fetch("https://api.parasut.com/oauth/token",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({client_id:this.config.clientId,client_secret:this.config.clientSecret,username:this.config.username,password:this.config.password,grant_type:"password",redirect_uri:"urn:ietf:wg:oauth:2.0:oob"})});if(!a.ok){let e=await a.text();throw console.error("Parasut auth failed:",e),new Error("Failed to authenticate with Parasut")}let t=await a.json();return this.accessToken=t.access_token,this.tokenExpiry=Date.now()+(t.expires_in-300)*1e3,console.log("Parasut: Authenticated successfully"),this.accessToken}async createMinimalContact(a){let{companyId:t}=this.config;try{let n=await fetch(`https://api.parasut.com/v4/${t}/contacts?filter[name]=Muhtelif%20M%C3%BC%C5%9Fteriler`,{headers:{Authorization:`Bearer ${a}`}});if(n.ok){let d=(await n.json()).data?.[0];if(d)return console.log("Parasut: Found existing Muhtelif M√º≈üteriler contact"),d.id}}catch{}let e={data:{type:"contacts",attributes:{name:"Muhtelif M√º≈üteriler",contact_type:"person",account_type:"customer",tax_number:"11111111111",city:"Istanbul",district:"Kadikoy"}}},s=await fetch(`https://api.parasut.com/v4/${t}/contacts`,{method:"POST",headers:{Authorization:`Bearer ${a}`,"Content-Type":"application/json"},body:JSON.stringify(e)});if(!s.ok){if(s.status===422){console.log("Parasut: Contact already exists, searching...");let o=await fetch(`https://api.parasut.com/v4/${t}/contacts?filter[name]=Muhtelif`,{headers:{Authorization:`Bearer ${a}`}});if(o.ok){let i=(await o.json()).data?.[0];if(i)return i.id}}let n=await s.text();throw console.error("Parasut create minimal contact error:",n),new Error("Failed to create minimal contact")}let r=await s.json();return console.log("Parasut: Created Muhtelif M√º≈üteriler contact:",r.data.id),r.data.id}async createCompanyContact(a,t){let{companyId:e}=this.config;try{let o=await fetch(`https://api.parasut.com/v4/${e}/contacts?filter[tax_number]=${t.vkn}`,{headers:{Authorization:`Bearer ${a}`}});if(o.ok){let i=(await o.json()).data?.[0];if(i)return console.log("Parasut: Found existing company contact by VKN"),i.id}}catch{}let s={data:{type:"contacts",attributes:{name:t.companyName,contact_type:"company",account_type:"customer",tax_office:t.taxOffice,tax_number:t.vkn,address:t.address,city:t.city,district:t.district,email:t.email||void 0,phone:t.phone||void 0}}},r=await fetch(`https://api.parasut.com/v4/${e}/contacts`,{method:"POST",headers:{Authorization:`Bearer ${a}`,"Content-Type":"application/json"},body:JSON.stringify(s)});if(!r.ok){if(r.status===422){let d=await fetch(`https://api.parasut.com/v4/${e}/contacts?filter[tax_number]=${t.vkn}`,{headers:{Authorization:`Bearer ${a}`}});if(d.ok){let u=(await d.json()).data?.[0];if(u)return u.id}}let o=await r.text();throw console.error("Parasut create company contact error:",o),new Error("Failed to create company contact")}let n=await r.json();return console.log("Parasut: Created company contact:",n.data.id),n.data.id}async getOrCreateProduct(a){let{companyId:t}=this.config,e="Patron Premium √úyelik (1 Ay)";try{let o=await fetch(`https://api.parasut.com/v4/${t}/products?filter[name]=${encodeURIComponent(e)}`,{headers:{Authorization:`Bearer ${a}`}});if(o.ok){let i=(await o.json()).data?.[0];if(i)return console.log("Parasut: Found existing product:",i.id),i.id}}catch{console.log("Parasut: Product search failed, will create new")}let s={data:{type:"products",attributes:{name:e,vat_rate:20,unit:"Adet",sales_price:1e3,currency:"TRL",product_type:"service"}}},r=await fetch(`https://api.parasut.com/v4/${t}/products`,{method:"POST",headers:{Authorization:`Bearer ${a}`,"Content-Type":"application/json"},body:JSON.stringify(s)});if(!r.ok){let o=await r.text();throw console.error("Parasut create product error:",o),new Error("Failed to create product")}let n=await r.json();return console.log("Parasut: Created product:",n.data.id),n.data.id}async createSalesInvoice(a,t,e,s){let{companyId:r}=this.config,n=await this.getOrCreateProduct(a),o=e/1.2,d={data:{type:"sales_invoices",attributes:{item_type:"invoice",description:`Patron Premium √úyelik - Sipari≈ü #${s}`,issue_date:new Date().toISOString().split("T")[0],due_date:new Date().toISOString().split("T")[0],currency:"TRL",city:"Istanbul",district:"Kadikoy"},relationships:{contact:{data:{type:"contacts",id:t}},details:{data:[{type:"sales_invoice_details",attributes:{quantity:1,unit_price:o,vat_rate:20},relationships:{product:{data:{type:"products",id:n}}}}]}}}},i=await fetch(`https://api.parasut.com/v4/${r}/sales_invoices`,{method:"POST",headers:{Authorization:`Bearer ${a}`,"Content-Type":"application/json"},body:JSON.stringify(d)});if(!i.ok){let g=await i.text();throw console.error("Parasut create invoice error:",g),new Error("Failed to create invoice")}let u=await i.json();return console.log("Parasut: Created invoice:",u.data.id),u.data.id}async recordPayment(a,t,e,s){let{companyId:r}=this.config,n={data:{type:"payments",attributes:{date:new Date().toISOString().split("T")[0],amount:e,description:`PayTR √ñdeme - ${s}`},relationships:{payable:{data:{type:"sales_invoices",id:t}}}}},o=await fetch(`https://api.parasut.com/v4/${r}/payments`,{method:"POST",headers:{Authorization:`Bearer ${a}`,"Content-Type":"application/json"},body:JSON.stringify(n)});if(o.ok)console.log("Parasut: Payment recorded");else{let d=await o.text();console.error("Parasut record payment error:",d)}}async generateEArchive(a,t){let{companyId:e}=this.config,s={data:{type:"e_archives",relationships:{sales_invoice:{data:{type:"sales_invoices",id:t}}}}},r=await fetch(`https://api.parasut.com/v4/${e}/e_archives`,{method:"POST",headers:{Authorization:`Bearer ${a}`,"Content-Type":"application/json"},body:JSON.stringify(s)});if(!r.ok){let o=await r.text();throw console.error("Parasut generate e-archive error:",o),new Error("Failed to generate e-archive")}let n=await r.json();return console.log("Parasut: E-Archive created:",n.data.id),n.data.id}async getEArchivePdfUrl(a,t){let{companyId:e}=this.config,s=20,r=3e3;for(let n=0;n<s;n++){let o=await fetch(`https://api.parasut.com/v4/${e}/e_archives/${t}`,{headers:{Authorization:`Bearer ${a}`}});if(o.ok){let d=await o.json(),i=d.data.attributes.pdf_url;if(i)return console.log("Parasut: Got PDF URL"),i;let u=d.data.attributes.status;n%5===0&&console.log(`Parasut: E-Archive status: ${u}, attempt ${n+1}/${s}`)}await new Promise(d=>setTimeout(d,r))}return console.warn(`Parasut: PDF URL not available after ${s} attempts`),null}async getInvoicePrintUrl(a,t){let{companyId:e}=this.config;try{let s=await fetch(`https://api.parasut.com/v4/${e}/sales_invoices/${t}`,{headers:{Authorization:`Bearer ${a}`}});if(!s.ok)return console.error("Failed to get invoice:",s.status),null;let n=(await s.json()).data.attributes.print_url;return n?(console.log("Parasut: Got print URL"),n):null}catch(s){return console.error("Error getting invoice print URL:",s),null}}async createInvoice(a,t){try{let e=await this.getAccessToken(),s=a.totalAmount,r;t.invoiceType==="company"&&t.companyData?r=await this.createCompanyContact(e,t.companyData):r=await this.createMinimalContact(e);let n=await this.createSalesInvoice(e,r,s,a.merchantOid);await this.recordPayment(e,n,s,a.merchantOid);let o,d=null;try{o=await this.generateEArchive(e,n),o&&(d=await this.getEArchivePdfUrl(e,o))}catch(i){console.log("E-Archive generation failed:",i)}return{success:!0,invoiceId:n,eArchiveId:o,pdfUrl:d||void 0}}catch(e){return console.error("Parasut invoice creation failed:",e),{success:!1,error:e instanceof Error?e.message:"Unknown error"}}}};function y(){let c=process.env.PARASUT_CLIENT_ID,a=process.env.PARASUT_CLIENT_SECRET,t=process.env.PARASUT_USERNAME,e=process.env.PARASUT_PASSWORD,s=process.env.PARASUT_COMPANY_ID;return!c||!a||!t||!e||!s?(console.warn("Parasut: Missing configuration, service not available"),null):new f({clientId:c,clientSecret:a,username:t,password:e,companyId:s})}var P=process.env.WHATSAPP_PHONE_NUMBER_ID,w=process.env.WHATSAPP_ACCESS_TOKEN;async function E(c,a,t,e){if(!P||!w)return console.warn("WhatsApp: Missing credentials, cannot send document"),!1;try{let s=await fetch(`https://graph.facebook.com/v18.0/${P}/messages`,{method:"POST",headers:{Authorization:`Bearer ${w}`,"Content-Type":"application/json"},body:JSON.stringify({messaging_product:"whatsapp",to:c,type:"document",document:{link:a,caption:t,filename:e}})});if(!s.ok){let n=await s.json();return console.error("WhatsApp send document error:",n),!1}let r=await s.json();return console.log(`WhatsApp: Document sent to ${c}, id: ${r.messages?.[0]?.id}`),!0}catch(s){return console.error("WhatsApp send document failed:",s),!1}}async function v(c,a,t){let e=`Faturanƒ±z hazƒ±r!

Sipari≈ü No: ${t}

Patron Premium √ºyeliƒüiniz i√ßin te≈üekk√ºr ederiz. üôè`,s=`fatura-${t}.pdf`;return E(c,a,e,s)}var I=new A.DynamoDBClient({}),m=p.DynamoDBDocumentClient.from(I),l=process.env.CONVERSATIONS_TABLE||"turkish-logistics-conversations";async function x(c,a,t){try{let e=await fetch(`https://api.parasut.com/v4/${a}/sales_invoices/${t}?include=active_e_document`,{headers:{Authorization:`Bearer ${c}`}});if(!e.ok)return console.log(`Failed to get invoice ${t}: ${e.status}`),null;let r=(await e.json()).data.relationships?.active_e_document?.data;return r?.id?(console.log(`Found e-archive ID ${r.id} for invoice ${t}`),r.id):(console.log(`No active e-document found for invoice ${t}`),null)}catch(e){return console.error(`Error getting e-archive from invoice ${t}:`,e),null}}async function C(c,a,t){try{let e=await fetch(`https://api.parasut.com/v4/${a}/e_archives/${t}/pdf`,{headers:{Authorization:`Bearer ${c}`}});return e.ok?(await e.json()).data.attributes.url||null:(console.log(`Failed to get PDF for e-archive ${t}: ${e.status}`),null)}catch(e){return console.error(`Error getting PDF URL for e-archive ${t}:`,e),null}}async function R(c,a){let t=y();if(!t)return console.log("Parasut service not available"),null;if(!a)return console.log("No invoice ID available"),null;try{let e=await t.getAccessToken(),s=process.env.PARASUT_COMPANY_ID;if(!s)return console.log("PARASUT_COMPANY_ID not configured"),null;if(c){let o=await fetch(`https://api.parasut.com/v4/${s}/trackable_jobs/${c}`,{headers:{Authorization:`Bearer ${e}`}});if(o.ok){let i=(await o.json()).data.attributes.status;if(console.log(`Trackable job ${c}: status=${i}`),i!=="done")return console.log("E-archive job still processing"),null}}let r=await x(e,s,a);if(!r)return console.log("E-archive not ready yet"),null;let n=await C(e,s,r);return n&&console.log(`Got PDF URL for e-archive ${r}`),n}catch(e){return console.error("Error checking PDF status:",e),null}}async function D(){console.log("Starting PDF check..."),console.log(`Using table: ${l}`);let c=[],a,t=0;do{let r=await m.send(new p.ScanCommand({TableName:l,FilterExpression:"invoiceStatus = :status",ExpressionAttributeValues:{":status":"pending_pdf"},ExclusiveStartKey:a}));t+=r.ScannedCount||0,c.push(...r.Items||[]),a=r.LastEvaluatedKey}while(a);console.log(`Scanned ${t} items total, found ${c.length} pending PDF records`),c.length>0&&console.log("Records:",JSON.stringify(c.map(r=>({pk:r.pk,phone:r.phoneNumber}))));let e=0,s=0;for(let r of c){e++;let n=r.pk.replace("PAYMENT#",""),o=r.parasutTrackableJobId||r.parasutEArchiveId;if(!r.parasutInvoiceId||!r.phoneNumber){console.log(`Skipping ${n}: missing invoiceId or phoneNumber`);continue}let d=await R(o,r.parasutInvoiceId);if(d){console.log(`Sending PDF to ${r.phoneNumber} for ${n}`);let i=await v(r.phoneNumber,d,n);await m.send(new p.UpdateCommand({TableName:l,Key:{pk:r.pk,sk:r.sk},UpdateExpression:"SET invoiceStatus = :status, invoicePdfUrl = :pdfUrl, invoiceSentAt = :sentAt, updatedAt = :now",ExpressionAttributeValues:{":status":i?"sent":"pdf_ready",":pdfUrl":d,":sentAt":i?new Date().toISOString():null,":now":new Date().toISOString()}})),i&&s++,console.log(`PDF ${i?"sent":"ready but not sent"} for ${n}`)}else{let i=r.createdAt?new Date(r.createdAt):new Date,u=Date.now()-i.getTime(),g=60*60*1e3;u>g&&(console.log(`Record ${n} too old (${Math.round(u/6e4)}min), marking as failed`),await m.send(new p.UpdateCommand({TableName:l,Key:{pk:r.pk,sk:r.sk},UpdateExpression:"SET invoiceStatus = :status, invoiceError = :error, updatedAt = :now",ExpressionAttributeValues:{":status":"pdf_timeout",":error":"PDF not available after 1 hour",":now":new Date().toISOString()}})))}await new Promise(i=>setTimeout(i,500))}return console.log(`PDF check complete: processed=${e}, sent=${s}`),{processed:e,sent:s}}0&&(module.exports={handler});
//# sourceMappingURL=index.js.map
